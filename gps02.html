<!doctype html>
<html manifest="index.manifest">
<head>
<meta charset="utf-8">
<!-- 程式來源 https://blog.xuite.net/gkyo0510/wretch/242769650 -->
<title>GPS02</title>

</head>
<body onload="init();" bgcolor="black" text="white">
<canvas id="canvas"></canvas>
<font size="6">
<p id="posStr">111222</p>
</font>
<font size="5">
<p id="watchStr">監控狀態</p>
</font>
<input type="button" value="啟動GPS更新" onClick="startGPS();">
<input type="button" value="停止GPS更新" onClick="stopGPS();">

</body>
<script>
var debugMsg = "script 開始.";
//document.getElementById("posStr").innerHTML="";
    let prevLati = 22.9620338;   //關廟系統北上出口前2公里標示牌
    let prevLongi = 120.346256;
	
function init(){
	//alert("init");
	if( navigator.geolocation ) {
		navigator.geolocation.getCurrentPosition( geoYes, geoNo);
	}else {
		debugMsg += "navigator.geolocation物件失敗。";
	}
	//document.getElementById("posStr").innerHTML="script finish.";
	document.getElementById("watchStr").innerHTML=debugMsg;
	//alert("run drawMap()");
	drawBaseMap();
	startGPS();
}

var p2=[
	[22.658032475585777, 120.51462941403176,"國仁路口"],
	[22.661457518466925, 120.51546704670002, "瑞光彎道1"],
	[22.669040797908576, 120.51069667037709, "瑞光彎道2"],
	[22.675343791402256, 120.51041230398191, "瑞光彎道3"],
	[22.680967230062606, 120.5055987046144, "瑞光彎道4"],
	[22.692732317780546, 120.50245954225517,"海豐街"],
	[22.695511971450234, 120.5054161117716,"盛豐路"],
	[22.697465730730798, 120.5124731605147,"盛豐彎道1"],
	[22.701213109756527, 120.51893681604922,"盛豐彎道2"],
	[22.70880261417915, 120.52199195978083, "德和路"],
	[22.7151486520024, 120.52903378461157, "海豐交流道"],
	[22.753526095626334, 120.49163293266612,"九如交流道"]
];
	var p3=[
	/*
		[22.6659424,120.5005407],	//阿婆粉圓冰
		[22.6618443,120.5069158],		//演藝廳
		[22.66238,120.5079811],			//民生國小
		[22.6603804,120.5111652],		//全家超商
		*/

		[22.658032475585777, 120.51462941403176,"國仁路口"],
		[22.651514894343208, 120.52598275892676,"麟洛路口"],
		[22.6400416, 120.5362810, "麟洛國中路口"],

		[22.655381953796578, 120.55160925823591, "科大路口"],
		[22.652601671108002, 120.56930340677384, "科大彎道"],
		[22.630047211459626, 120.59291416762996, "老埤路口"],
		[22.633128880246172, 120.59797113670795, "安通路口"],

		[22.62871783050417, 120.62638157350078,"沿山路口"],
		[22.591721713708438, 120.62115374455101, "佳平路口"],
		[22.5727629,120.6509855,"急彎,逍遙山莊"],
		[22.58924109879525, 120.66460999148127, "大武山之門"],
		[22.6145008,120.7017865,"北大武山步道"]
		];
		var points = p3;
		var nextPoint = 0;	//下一個點
	var wPoint =  120.51431010230766;	//points[nextPoint][1];//120.5116;		//最西點
	var recentLongi = 120.51431010230766;
	//ar ePoint = 120.52;		//最東點
	var nPoint = 22.659517486714293;	//points[nextPoint][0];//22.659;		//最北點
	var recentLati = 22.659517486714293;


	
	var nextDist = -1;
	var preDist = 0;
	
	var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");

canvas.width = 950;canvas.height = 1000;		//寬高預設值為300×150
	var centerX = canvas.width / 8;
	var centerY = canvas.height / 2;
	var zoon = 4000;//canvas.width / Math.abs(wPoint - ePoint);
	
function drawBaseMap(){
//alert("drawMap()");
//畫圖

ctx.fillStyle = "black";	//填滿色
ctx.fillRect(0,0,canvas.width,canvas.height);
	
	ctx.beginPath();
ctx.strokeStyle = "blue";	//線條色
ctx.lineWidth = 2;	//線條粗度
ctx.strokeRect(0,0,canvas.width,canvas.height);
ctx.stroke();

//	ctx.fillText("許功蓋", 10, 50);

	//螢幕中央標示
ctx.strokeStyle = "red";	//線條色
ctx.lineWidth = 1;	//線條粗度
	ctx.beginPath();
	ctx.moveTo(centerX - 10, centerY);
    ctx.lineTo(centerX + 10, centerY);
	ctx.moveTo(centerX, centerY - 10);
    ctx.lineTo(centerX, centerY + 10);
    //ctx.arc(nPoint, wPoint,3,0,Math.PI*2,true);
	ctx.stroke();
	

	/*
	//points.forEach(function drawPoint(value[0],value[1],"green",2);
	for ( indexP in points){		//TODO 改用Path2D物件
		drawPoint(points[indexP][0], points[indexP][1], "green", 2);
	}
	

	ctx.strokeStyle = "red";
		ctx.lineWidth = 1;	//線條粗度
		ctx.beginPath();
		//ctx.moveTo(0,0);
		//alert(mapPoints[0][0] +"," + mapPoints[0][1]);
	for ( p in mapPoints){		//TODO 改用Path2D物件
		ctx.lineTo(mapPoints[p][0], mapPoints[p][1]);
	}
		ctx.stroke();
		


	ctx.beginPath();
	//ctx.moveTo(points[0][0], points[0][1]);
	for ( p in mapPoints){		//TODO 改用Path2D物件
		ctx.moveTo(mapPoints[p][0], mapPoints[p][1]);
		ctx.arc(mapPoints[p][0], mapPoints[p][1],5,0,Math.PI*2,true);
	}
	  ctx.stroke();
 */

	//console.log(zoon);
	var mapPoints = gps2scr(points);
     var circle = new Path2D();
	 var path = new Path2D();
 	for ( p in mapPoints){		//TODO 改用Path2D物件
			circle.moveTo(mapPoints[p][0], mapPoints[p][1]);
			circle.arc(mapPoints[p][0], mapPoints[p][1],3,0,Math.PI*2,true);
			path.lineTo(mapPoints[p][0], mapPoints[p][1]);
	}
	 	ctx.strokeStyle = "green";	//線條色
	ctx.lineWidth = 2;	//線條粗度
	  ctx.stroke(circle);
	  ctx.lineWidth = 3;	//線條粗度
	  	  ctx.stroke(path);
}

function gps2scr(sourcePs){		//經緯度座標轉螢幕座標
	var newPs=new Array();
	for(var i=0; i<sourcePs.length; i++){
		newPs[i] = new Array();
		newPs[i][0] =	(sourcePs[i][1] - recentLongi )* zoon + centerX;
		newPs[i][1] =	-(sourcePs[i][0] -recentLati )*zoon + centerY;
	}
	return newPs;
}

function drawPoint(lat, lon, color, width){
	var drawX = (lon - points[nextPoint][1] )* zoon + centerX;
	var drawY = -(lat - points[nextPoint][0] )*zoon + centerY;
	//console.log(drawX + "," + drawY);
	ctx.strokeStyle = color;	//線條色
	ctx.lineWidth = width;	//線條粗度
	
	ctx.beginPath();
	//ctx.moveTo(drawX, drawY);
	//ctx.lineTo(drawX, drawY);
    ctx.arc(drawX, drawY,3,0,Math.PI*2,true);
	//ctx.lineWidth = 10;	//線條粗度
	//ctx.strokeStyle = "green";	//線條色
	ctx.stroke();
}
	
//============================================
function geoYes(evt){
//debugMsg += "getYes開始。";

recentLati = evt.coords.latitude;
recentLongi = evt.coords.longitude;
nextDist  = getDistance(recentLati, recentLongi,  points[nextPoint][0], points[nextPoint][1]);
drawPoint(recentLati, recentLongi, "red", 2);

var d=new Date();
strTime = d.getHours()+":" + d.getMinutes()+ ":" +d.getSeconds();
str = "時間:" + strTime;
//alert(str);
//str += "<br />現在位置:" + recentLati.toFixed(7) + ", "+ recentLongi.toFixed(7);
str += "<br/>速度："+ Math.round(evt.coords.speed)/1000 + "公里/小時。方向：" + evt.coords.heading;	//方向為正北的順時針
//str += "<br />精確度" + evt.coords.accuracy;
str += "<br />目標:" + points[nextPoint][2];		//prevLati.toFixed(7) + ", " + prevLongi.toFixed(7);
str += "<br />直線距離:" + nextDist +"公里";
//prevLati = evt.coords.latitude;
//prevLongi = evt.coords.longitude;

document.getElementById("posStr").innerHTML=str;

//debugMsg += "geoYes()完成。";
document.getElementById("watchStr").innerHTML=debugMsg;

if (nextDist < 0.005 && (nextDist > preDist) ){	//目標5公尺內才判斷是否通過
	nextPoint++;
	preDist = getDistance(recentLati, recentLongi,  points[nextPoint][0], points[nextPoint][1]);
}else{
	preDist = nextDist;
}


/*
str = "https://maps.googleapis.com/maps/api/staticmap"+
        "?zoom=15&size=300x300&sensor=false&center=" + 
        evt.coords.latitude +","+ evt.coords.longitude+
        "&markers=color:red%7C"+evt.coords.latitude +","+
         evt.coords.longitude;
 document.getElementById("map").src = str;    //要附API Key才能用。
//Google Map 2018.07.16以後開始收費
document.getElementById("msg").innerText = str;
*/
}

function geoNo(evt){
//限https? win10本機檔用Chrome可開允許,但仍取得失敗。 手機note9待測
debugMsg = "GPS取得失敗。";
document.getElementById("watchStr").innerHTML=debugMsg;
}

var watchID;
function startGPS(){
	var options = {
	  enableHighAccuracy: true,
	  timeout: 5000,
	  maximumAge: 0
	};
	watchID = navigator.geolocation.watchPosition( geoYes, geoNo, options);

	document.getElementById("watchStr").innerHTML="GPS正在監控中...";
}

function stopGPS(){
	navigator.geolocation.clearWatch( watchID );
	document.getElementById("watchStr").innerHTML="GPS停止監控...";
}

function getDistance(lat1, lon1, lat2, lon2) {
    //本函式來源 https://www.geodatasource.com/developers/javascript

    var radlat1 = Math.PI * lat1/180;
    var radlat2 = Math.PI * lat2/180;
    var theta = lon1-lon2;
    var radtheta = Math.PI * theta/180;
    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    if (dist > 1) {
        dist = 1;
    }
    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;	//不明常數
    dist = dist * 1.609344 ;		//英浬轉公里

    return dist.toFixed(3);		//小數點後三位

}
</script>
</html>