<!doctype html>
<html manifest="index.manifest">
<head>
<meta charset="utf-8">
<!-- 程式來源 https://blog.xuite.net/gkyo0510/wretch/242769650 -->
<title>GPS02-2</title>

</head>
<body onload="init();" bgcolor="black" text="white" topmargin="0" leftmargin="0">
<canvas id="canvas"></canvas>
<font size="7">
<p id="posStr">111222</p>
</font>
<font size="6">
<p id="watchStr">監控狀態</p>
</font>
<input type="button" value="啟動GPS更新" onClick="startGPS();">
<input type="button" value="停止GPS更新" onClick="stopGPS();">

</body>
<script title="座標圖資">

//document.getElementById("posStr").innerHTML="";
//    let prevLati = 22.9620338;   //關廟系統北上出口前2公里標示牌
//    let prevLongi = 120.346256;
	
var tasks = [[
		[22.6660872645837, 120.50037043288955, "工業路口"],
		[22.665707901738443, 120.5010424041541, "69巷"],
		[22.66528466599206, 120.5017954343364, "殺蛇溪"],
		[22.665066241181687, 120.50217027304704, "民福路"],
		//[22.66379809138713, 120.50183335621948, "民興路"],
		//[22.663710225539916, 120.50237449188843, "63巷"],
		[22.6642219442753, 120.50369274070279, "民生校區"],
		[22.66339089234732, 120.50520474477672, "菸廠路"],
		[22.66279229323675, 120.50623662222313, "瑞民路口"],
		[22.662224974588675, 120.50727148282286, "歸仁路口"],
		[22.660783934931143, 120.50977659008726, "瑞屏街口"],
		[22.65990848834937, 120.51121889337335, "和生路口"],
		[22.659470893607228, 120.51209569251994, "安心四橫巷"],
		[22.65982669905339, 120.51235318458225, "田中巷口"],
		[22.65956412062677, 120.5130726983204, "二橫巷"],
		[22.659505837597436, 120.5143833817605, "10號"],
		[22.659390282100908, 120.51514639840148, "瑞光路口"],
		[22.658030217493362, 120.514628916623, "國仁路口"],
		[22.652150360224123, 120.51053770124854, "歸禮巷"],
		[22.651995666533377, 120.5111949090511, "彎01"],
		[22.651445528597453, 120.51110103173282, "彎02"],
		[22.65037439483884, 120.51412461031919, "路口"]
	],
[
	[22.658034247616996, 120.5146302173418,"國仁路口"],
	[22.659914735641667, 120.51117374021372,"屏商路口"],
	[22.65983459647982, 120.50578459146016,"歸仁彎"],
	[22.652905040831186, 120.49474121968251, "和生彎"],
	[22.651762313125314, 120.48597167701199, "復興路口"],
	[22.655823532381984, 120.46656980548235, "建國路口"],
	[22.642159446314253, 120.4185087722723, "磚仔窰"],
	[22.633618032191855, 120.38857434750723, "賓士路口"],
	[22.63635369740717, 120.38229941534014,"彎道1"],
	[22.635421093866388, 120.37318949926723, "彎道2"],
	[22.63413212059094, 120.37012392539445, "彎道3"],
	[22.63634876160687, 120.35721342010389, "文衡路"],
	[22.634581156634074, 120.35822752986832, "文衡彎道"],
	[22.63337989604311, 120.3579774601367, "文化路"],
	[22.633949053558847, 120.35468108635685, "大潤發"]	
],
[
	[22.658034247616996, 120.5146302173418,"國仁路口"],
	[22.661457518466925, 120.51546704670002, "瑞光彎道1"],
	[22.669040797908576, 120.51069667037709, "瑞光彎道2"],
	[22.675343791402256, 120.51041230398191, "瑞光彎道3"],
	[22.680967230062606, 120.5055987046144, "瑞光彎道4"],
	[22.692732317780546, 120.50245954225517,"海豐街"],
	[22.695511971450234, 120.5054161117716,"盛豐路"],
	[22.697465730730798, 120.5124731605147,"盛豐彎道1"],
	[22.701213109756527, 120.51893681604922,"盛豐彎道2"],
	[22.70880261417915, 120.52199195978083, "德和路"],
	[22.7151486520024, 120.52903378461157, "海豐交流道"],
	[22.753526095626334, 120.49163293266612,"九如交流道"]
],[
		[22.658034247616996, 120.5146302173418,"國仁路口"],
		[22.651514894343208, 120.52598275892676,"麟洛路口"],
		[22.6400416, 120.5362810, "麟洛國中路口"],

		[22.655381953796578, 120.55160925823591, "科大路口"],
		[22.652601671108002, 120.56930340677384, "科大彎道"],
		[22.630047211459626, 120.59291416762996, "老埤路口"],
		[22.633128880246172, 120.59797113670795, "安通路口"],

		[22.62871783050417, 120.62638157350078,"沿山路口"],
		[22.591721713708438, 120.62115374455101, "佳平路口"],
		[22.5727629,120.6509855,"急彎,逍遙山莊"],
		[22.58924109879525, 120.66460999148127, "大武山之門"],
		[22.6145008,120.7017865,"北大武山步道"]
		],[
			[22.666540670813557, 120.50113642730727, "民利路"],
			[22.66728729803525, 120.4997624132888, "民教路"],
			[22.668284731721105, 120.49808200934285, "廣東路"],
			[22.667523721107013, 120.4978306934891, "民生路"],
			[22.66566750271852, 120.4961204306436, "民有一路"],
			[22.664495102608665, 120.49399094587267, "台糖三街"],
			[22.66472029116734, 120.49111723281767, "台糖一街"],
			[22.662416069802465, 120.49028271413977, "台糖街"],
			[22.66159915133573, 120.49302542015064, "台糖三街2"]

		]];
	</script>
<script title="程式碼">
		var debugMsg = "script 開始.";
		var taskID = -1;
		var points = [];
		var taskTitle = "";
		var zoon = -1;
		
		var nextPoint = 0;	//下一個點
	//var wPoint =  120.51431010230766;	//points[nextPoint][1];//120.5116;		//最西點
	//var recentLongi = 120.51431010230766;
	//ar ePoint = 120.52;		//最東點
//var nPoint = 22.659517486714293;	//points[nextPoint][0];//22.659;		//最北點
	//var recentLati = 22.659517486714293;
	var Point01 = [22.659517486714293,120.51431010230766, "田中巷"];	
	var Point02 = [22.666152566994903, 120.50087279317975,"後門"];
	var recentPoint = Point02;
	var centerCoords = [23,120.5];
	
	var nextDist = -1;
	var preDist = 0;
	var vector = 1;
	
	var canvas = document.getElementById("canvas");
	canvas.addEventListener("click", doMouseDown, false);
var ctx = canvas.getContext("2d");

//canvas.width = 950;canvas.height = 950;		//寬高預設值為300×150
canvas.width = window.innerWidth;
canvas.height = canvas.width;
	var centerX = canvas.width  / 2;
	var centerY = canvas.height / 2;
	

	//var scrPoint = gps2scr(recentPoint);
	const audio = new Audio();
	audio.volume = 0.1;
	        
function init(){
	//alert("init");
	if( navigator.geolocation ) {
		navigator.geolocation.getCurrentPosition( geoYes, geoNo);
	}else {
		debugMsg += "navigator.geolocation物件失敗。";
	}
	//document.getElementById("posStr").innerHTML="script finish.";
	document.getElementById("watchStr").innerHTML=debugMsg;
	//alert("run drawMap()");
	nextTask();
	startGPS();
	noSleep();
}

async function noSleep(){
// The wake lock sentinel.
let wakeLock = null;
// Function that attempts to request a screen wake lock.
const requestWakeLock = async () => {
try {
wakeLock = await navigator.wakeLock.request('screen');
	wakeLock.addEventListener('release', () => {
	console.log('Screen Wake Lock was released');
	});
console.log('Screen Wake Lock is active');
alert("NoSleep");
} catch (err) {
console.error(`${err.name}, ${err.message}`);
}
};
// Request a screen wake lock…
await requestWakeLock();
}

function doMouseDown(event){

		var x = event.pageX;
		var y = event.pageY;
		
		var gridW = canvas.width/3;
		var gridH = canvas.height/3;
		
		//alert(x + ", "+ y);
		if(x > gridW*2 && y > gridH*2){	//右下角
		console.log("右下角_任務切換");
			nextTask();
			return;
		}
		//
		if(x > gridW*2 && y < gridH){//右上角
		console.log("右上角_跳過目標");
			nextPoint += vector;
			preDist = getDistance(recentPoint[0], recentPoint[1],  points[nextPoint][0], points[nextPoint][1]);
		return;
		}
		if(x < gridW && y < gridH){//左上角
			console.log("左上角_去回切換");
			if(vector ==1){
			vector = -1;//回程
			nextPoint = points.length;
			}else{
			vector = 1;//去程
			nextPoint = 0;
			}
			return;
		}
		
		if(x < gridW && y > gridH*2){//左下角
		console.log("左下角_測試音效");
		audio.setAttribute('src',"voice/號誌.wav");
			audio.load();
			audio.play();
		return;
		}
	}

function nextTask(){
	taskID ++;
	nextPoint = 0;
	 nextDist = -1;
	preDist = 0;
	if (taskID == tasks.length) taskID = 0;
	points = tasks[taskID];
	taskTitle = points[0][2] + " - " + points[points.length-1][2];
	if(vector == -1) taskTitle += "(回程)";
	drawBaseMap();
}	
	
function drawBaseMap(){
//alert("drawMap()");
//畫圖

ctx.fillStyle = "black";	//填滿色
ctx.fillRect(0,0,canvas.width,canvas.height);
	
	//ctx.beginPath();
ctx.strokeStyle = "blue";	//線條色
ctx.lineWidth = 2;	//線條粗度
ctx.strokeRect(0,0,canvas.width,canvas.height);
//ctx.stroke();

//	ctx.fillText("許功蓋", 10, 50);

	//螢幕中央標示
	/*
ctx.strokeStyle = "red";	//線條色
ctx.lineWidth = 5;	//線條粗度
	ctx.beginPath();
	ctx.moveTo(centerX - 30, centerY);
    ctx.lineTo(centerX + 30, centerY);
	ctx.moveTo(centerX, centerY - 30);
    ctx.lineTo(centerX, centerY + 30);
    //ctx.arc(nPoint, wPoint,3,0,Math.PI*2,true);
	ctx.stroke();
	*/

	/*
	//points.forEach(function drawPoint(value[0],value[1],"green",2);
	for ( indexP in points){		//TODO 改用Path2D物件
		drawPoint(points[indexP][0], points[indexP][1], "green", 2);
	}
	

	ctx.strokeStyle = "red";
		ctx.lineWidth = 1;	//線條粗度
		ctx.beginPath();
		//ctx.moveTo(0,0);
		//alert(mapPoints[0][0] +"," + mapPoints[0][1]);
	for ( p in mapPoints){		//TODO 改用Path2D物件
		ctx.lineTo(mapPoints[p][0], mapPoints[p][1]);
	}
		ctx.stroke();
		


	ctx.beginPath();
	//ctx.moveTo(points[0][0], points[0][1]);
	for ( p in mapPoints){		//TODO 改用Path2D物件
		ctx.moveTo(mapPoints[p][0], mapPoints[p][1]);
		ctx.arc(mapPoints[p][0], mapPoints[p][1],5,0,Math.PI*2,true);
	}
	  ctx.stroke();
 */
 /*
 for(p in points){
	points[p][0] = Math.round(points[p][0], -5);
	points[p][1] = Math.round(points[p][1], -5);
 }
 */
 //找出四邊的點以算出放大值zoon
var maxN = points[0][0];
var maxS = points[0][0];
var maxE = points[0][1];
var maxW = points[0][1];
for(p in points){
	if(points[p][0] > maxN) maxN = points[p][0];
	if(points[p][0] < maxS) maxS = points[p][0];
	if(points[p][1] > maxE) maxE = points[p][1];
	if(points[p][1] < maxW) maxW = points[p][1];
}

console.log("maxN=" + maxN);
console.log("maxS=" + maxS);
console.log("maxE=" + maxE);
console.log("maxW=" + maxW);

if((maxN - maxS) >(maxE - maxW)){	//範圍大的用來算比例
	zoon = canvas.height * 0.9/(maxN - maxS);
	console.log("垂直比例=" + zoon);
	}else{
	zoon = canvas.width * 0.9/(maxE - maxW);
	console.log("水平比例=" + zoon);
	}
recentPoint[0] = (maxN + maxS)/2;
recentPoint[1] = (maxE + maxW)/2;

centerCoords[0] = recentPoint[0];
centerCoords[1] = recentPoint[1];

//畫路線圖(點與線)
	//console.log(zoon);
	var mapPoints = gps2scr(points);
     var circle = new Path2D();
	 var circle2 = new Path2D();
	 var path = new Path2D();
 	for ( p in mapPoints){		//TODO 改用Path2D物件
			circle.moveTo(mapPoints[p][0], mapPoints[p][1]);
			circle.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
			circle2.moveTo(mapPoints[p][0], mapPoints[p][1]);
			circle2.arc(mapPoints[p][0], mapPoints[p][1],5,0,Math.PI*2,true);
			path.lineTo(mapPoints[p][0], mapPoints[p][1]);
	}
	 	ctx.strokeStyle = "green";	//線條色
		
			  ctx.lineWidth = 10;	//線條粗度
	  	  ctx.stroke(path);
		  
	ctx.lineWidth = 3;	//線條粗度
	  ctx.stroke(circle);
	  
	  ctx.fillStyle = "black";
	  ctx.fill(circle2);
	  

}

function gps2scr(sourcePs){		//經緯度座標轉螢幕座標
	var newPs=new Array();
	for(var i=0; i<sourcePs.length; i++){
		newPs[i] = new Array();
		newPs[i][0] =  (sourcePs[i][1] - centerCoords[1] )* zoon + centerX;
		newPs[i][1] = -(sourcePs[i][0] - centerCoords[0] )*zoon + centerY;
	}
	return newPs;
}

function drawPoint_x(lat, lon, color, width){
	var drawX = (lon - points[nextPoint][1] )* zoon + centerX;
	var drawY = -(lat - points[nextPoint][0] )*zoon + centerY;
	//console.log(drawX + "," + drawY);
	ctx.strokeStyle = color;	//線條色
	ctx.lineWidth = width;	//線條粗度
	
	ctx.beginPath();
	//ctx.moveTo(drawX, drawY);
	//ctx.lineTo(drawX, drawY);
    ctx.arc(drawX, drawY,3,0,Math.PI*2,true);
	//ctx.lineWidth = 10;	//線條粗度
	//ctx.strokeStyle = "green";	//線條色
	ctx.stroke();
}
	
//============================================
function geoYes(evt){

debugMsg = "";

//recentLati = evt.coords.latitude;
//recentLongi = evt.coords.longitude;
recentPoint[0] = evt.coords.latitude;
recentPoint[1] = evt.coords.longitude;
/*
recentPoint[0]= Math.round(evt.coords.latitude, -5);
recentPoint[1]= Math.round(evt.coords.longitude,-5);
*/
nextDist  = getDistance(recentPoint[0], recentPoint[1],  points[nextPoint][0], points[nextPoint][1]);
//drawPoint(recentPoint[0], recentPoint[1], "red", 2);

	var drawX =  (recentPoint[1] - centerCoords[1])* zoon+ centerX;
	var drawY = -(recentPoint[0] - centerCoords[0])*zoon + centerY;
	//alert(drawX+ ", " + drawY);
	ctx.strokeStyle ="red";	//線條色
	ctx.lineWidth = 1;	//線條粗度
	ctx.beginPath();
    ctx.arc(drawX, drawY,1,0,Math.PI*2,true);
	ctx.stroke();
	
var d=new Date();
strTime = d.getHours()+":" + d.getMinutes()+ ":" +d.getSeconds()+ " " + d.getMilliseconds();
str = "任務："+ taskTitle;
str += "<br/>時間：" + strTime;
//alert(str);
//str += "<br />位置：" + recentPoint[0] + ", "+ recentPoint[1];
str += "<br/>速度："+ Math.round(evt.coords.speed*3.6, -1) + "公里/小時。";	//原單位：米/秒
	str += "方向：" + Math.round(evt.coords.heading);	//方向為正北的順時針
str += "<br />目標：" + points[nextPoint][2];
//	str += "("+ points[nextPoint][0] +", " + points[nextPoint][1];
str += "<br />距離：" + nextDist  + "公里";
//prevLati = evt.coords.latitude;
//prevLongi = evt.coords.longitude;

document.getElementById("posStr").innerHTML=str;


//時速60公里 = 每秒60x1000/60x60 = 60/3.6 = 16.6公尺
if (nextDist < 0.02 && (nextDist > preDist) ){	//目標20公尺內才判斷是否通過, 要看速度決定?
	nextPoint += vector;
	preDist = getDistance(recentPoint[0], recentPoint[1],  points[nextPoint][0], points[nextPoint][1]);
}else{
	preDist = nextDist;
}

debugMsg += "GPS ok.";
document.getElementById("watchStr").innerHTML = debugMsg;
/*
str = "https://maps.googleapis.com/maps/api/staticmap"+
        "?zoom=15&size=300x300&sensor=false&center=" + 
        evt.coords.latitude +","+ evt.coords.longitude+
        "&markers=color:red%7C"+evt.coords.latitude +","+
         evt.coords.longitude;
 document.getElementById("map").src = str;    //要附API Key才能用。
//Google Map 2018.07.16以後開始收費
document.getElementById("msg").innerText = str;
*/
}

function geoNo(evt){
//限https? win10本機檔用Chrome可開允許,但仍取得失敗。 手機note9待測
debugMsg = "GPS取得失敗。";
document.getElementById("watchStr").innerHTML=debugMsg;
}

var watchID;
function startGPS(){
	var options = {
	  enableHighAccuracy: true,
	  timeout: 5000,
	  maximumAge: 0
	};
	watchID = navigator.geolocation.watchPosition( geoYes, geoNo, options);

	document.getElementById("watchStr").innerHTML="GPS正在監控中...";
}

function stopGPS(){
	navigator.geolocation.clearWatch( watchID );
	document.getElementById("watchStr").innerHTML="GPS停止監控...";
}

function getDistance(lat1, lon1, lat2, lon2) {
    //本函式來源 https://www.geodatasource.com/developers/javascript

    var radlat1 = Math.PI * lat1/180;
    var radlat2 = Math.PI * lat2/180;
    var theta = lon1-lon2;
    var radtheta = Math.PI * theta/180;
    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    if (dist > 1) {
        dist = 1;
    }
    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;	//不明常數
    dist = dist * 1.609344 ;		//英浬轉公里

    return dist.toFixed(3);		//小數點後三位

}
</script>
</html>