<!doctype html>
<html manifest="index.manifest">
<head>
<meta charset="utf-8">
<!-- 程式來源 https://blog.xuite.net/gkyo0510/wretch/242769650 -->
<title>GPS01</title>

<style>
/* 字型大小自適應來源 https://www.minwt.com/webdesign-dev/css/20278.html*/
html{
  font-size: 14px;
}

@media (min-width: 600px) and (max-width: 1200px) {
  html {
   font-size: calc(1.2rem + (1.3-1.2) * ((100vw - 600px) / (1200 - 600)));
  }
}

@media (min-width: 1200px) {
  html {
     font-size: 1.3rem;
  }
}
</style>

</head>
<body>
<h1>定位資訊 </h1>
<p id="posStr">111222</p>
<p id="watchStr">監控狀態</p>
<p>
<input type="button" value="啟動GPS更新" onClick="startGPS();">
<input type="button" value="停止GPS更新" onClick="stopGPS();">
</p>

<hr>
<p><img id="map"/></p>
<div id="msg"></div>
</body>
<script>
document.getElementById("posStr").innerHTML="script start.";
    let prevLati = 22.9620338;   //關廟系統北上出口前2公里標示牌
    let prevLongi = 120.346256;

if( navigator.geolocation ) {

	navigator.geolocation.getCurrentPosition( geoYes, geoNo);
}
else {
	document.getElementById("watchStr").innerHTML="navigator.geolocation失敗。";
}
//document.getElementById("posStr").innerHTML="script finish.";

function geoYes(evt){
//alert(evt);
recentLati = evt.coords.latitude
recentLongi = evt.coords.longitude
var d=new Date();
strTime = d.getHours()+":" + d.getMinutes()+ ":" +d.getSeconds();
str = "時間:" + strTime;
str += "<br />位置:" + recentLati.toFixed(7) + ", "+ recentLongi.toFixed(7);
//str += "<br />精確度" + evt.coords.accuracy;
str += "<br />目標:" + prevLati.toFixed(7) + ", " + prevLongi.toFixed(7);
str += "<br />距離:" + distance(recentLati, recentLongi, prevLati, prevLongi).toFixed(3) +"公里";
//prevLati = evt.coords.latitude;
//prevLongi = evt.coords.longitude;

document.getElementById("posStr").innerHTML=str;
/*
str = "https://maps.googleapis.com/maps/api/staticmap"+
        "?zoom=15&size=300x300&sensor=false&center=" + 
        evt.coords.latitude +","+ evt.coords.longitude+
        "&markers=color:red%7C"+evt.coords.latitude +","+
         evt.coords.longitude;
 document.getElementById("map").src = str;    //要附API Key才能用。
//Google Map 2018.07.16以後開始收費
document.getElementById("msg").innerText = str;
*/
}
function geoNo(evt){
//網頁為本機檔則會失敗(手機note9或電腦win10都是)
document.getElementById("watchStr").innerHTML="GPS取得失敗。";
}

var watchID;
function startGPS(){
watchID = navigator.geolocation.watchPosition( geoYes, geoNo);

document.getElementById("watchStr").innerHTML="GPS正在監控中...";
}

function stopGPS(){
navigator.geolocation.clearWatch( watchID );
document.getElementById("watchStr").innerHTML="GPS停止監控中...";
}

function distance(lat1, lon1, lat2, lon2) {
    //本函式來源 https://www.geodatasource.com/developers/javascript

    var radlat1 = Math.PI * lat1/180;
    var radlat2 = Math.PI * lat2/180;
    var theta = lon1-lon2;
    var radtheta = Math.PI * theta/180;
    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    if (dist > 1) {
        dist = 1;
    }
    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;  //不明常數
    dist = dist * 1.609344  //英浬轉公里

    return dist;

}
</script>
</html>