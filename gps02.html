<!doctype html>
<html manifest="index.manifest">
<head>
<meta charset="utf-8">
<!-- 程式來源 https://blog.xuite.net/gkyo0510/wretch/242769650 -->
<title>GPS02</title>

<style>
/* 字型大小自適應來源 https://www.minwt.com/webdesign-dev/css/20278.html*/
html{
  font-size: 14px;
}

@media (min-width: 600px) and (max-width: 1200px) {
  html {
   font-size: calc(1.2rem + (1.3-1.2) * ((100vw - 600px) / (1200 - 600)));
  }
}

@media (min-width: 1200px) {
  html {
     font-size: 1.3rem;
  }
}
</style>

</head>
<body>
<canvas id="canvas"></canvas>
<p id="posStr">111222</p>
<p id="watchStr">監控狀態</p>
<p>
<input type="button" value="啟動GPS更新" onClick="startGPS();">
<input type="button" value="停止GPS更新" onClick="stopGPS();">
</p>

<hr>
<p><img id="map"/></p>
<div id="msg"></div>
</body>
<script>
var debugMsg = "script 開始.";
//document.getElementById("posStr").innerHTML="";
    let prevLati = 22.9620338;   //關廟系統北上出口前2公里標示牌
    let prevLongi = 120.346256;

if( navigator.geolocation ) {
debugMsg += "A1.";
	navigator.geolocation.getCurrentPosition( geoYes, geoNo);
	debugMsg += "A2.";
}else {
debugMsg += "B";
	debugMsg += "navigator.geolocation物件失敗。";
}
//document.getElementById("posStr").innerHTML="script finish.";
document.getElementById("watchStr").innerHTML=debugMsg;

//畫圖
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext("2d");

canvas.width = 1000;canvas.height = 1000;		//寬高預設值為300×150


ctx.strokeStyle = "green";	//線條色
ctx.lineWidth = 2;	//線條粗度
ctx.strokeRect(0,0,canvas.width,canvas.height);
/*
ctx.fillStyle = "green";
    ctx.fillRect(25,25,100,100);
    ctx.clearRect(45,45,60,60);
    ctx.strokeRect(50,50,50,50);


ctx.fillStyle = "white";	//填滿色
ctx.strokeStyle = "red";	//線條色
    ctx.beginPath();
    ctx.moveTo(75,50);
    ctx.lineTo(100,75);
    ctx.lineTo(100,25);
	    ctx.fill();		//填滿
	
	ctx.beginPath();
	ctx.lineWidth = 3;	//線條粗度
	ctx.moveTo(75,50);
    ctx.lineTo(180,75);
    ctx.lineTo(100,25);
	ctx.stroke();	//執行本行才畫線
	
	ctx.fillText("許功蓋", 10, 50);
*/	
	var points=[
	/*
		[22.6659424,120.5005407],	//阿婆粉圓冰
		[22.6618443,120.5069158],		//演藝廳
		[22.66238,120.5079811],			//民生國小
		[22.6603804,120.5111652],		//全家超商
		*/
		[22.6590325,120.5116325,"國仁醫院"],
		[22.6492241, 120.522914,"麟洛鄉公所"],
		[22.6400416, 120.5362810, "麟洛國中路口"],
		[22.655381953796578, 120.55160925823591, "科大路口"],
		[22.630047211459626, 120.59291416762996, "老埤路口"],
		[22.633128880246172, 120.59797113670795, "安通路口"],
		[22.62871783050417, 120.62638157350078,"沿山路口"],
		[22.591721713708438, 120.62115374455101, "佳平路口"],
		
		[22.5727629,120.6509855,"急彎,逍遙山莊"],
				
		[22.5838491,120.6723113,"北大武山步道"]
		];
	var wPoint = 120.51;		//最西點
	//ar ePoint = 120.52;		//最東點
	var nPoint = 22.668;		//最北點
	var zoon = 10000;//canvas.width / Math.abs(wPoint - ePoint);
	var nextPoint = 0;	//下一個點
	var nextDist = -1;
	var preDist = 0;
ctx.strokeStyle = "red";	//線條色
	ctx.beginPath();
    ctx.arc(nPoint, wPoint,3,0,Math.PI*2,true);
	ctx.stroke();
	
	ctx.strokeStyle = "green";	//線條色
	//console.log(zoon);
	for ( indexP in points){		//TODO 改用Path2D物件
		drawPoint(points[indexP][0], points[indexP][1]);
	}
	
function drawPoint(lat, lon){
	var drawX = (lon - wPoint )* zoon + canvas.width/2;
	var drawY = -(lat - nPoint )*zoon + canvas.height/2;
	//console.log(drawX + "," + drawY);
	
	ctx.beginPath();
	//ctx.moveTo(drawX, drawY);
	//ctx.lineTo(drawX, drawY);
    ctx.arc(drawX, drawY,3,0,Math.PI*2,true);
	//ctx.lineWidth = 10;	//線條粗度
	//ctx.strokeStyle = "green";	//線條色
	ctx.stroke();
}
	
//============================================
function geoYes(evt){
//debugMsg += "getYes開始。";

recentLati = evt.coords.latitude;
recentLongi = evt.coords.longitude;
nextDist  = getDistance(recentLati, recentLongi, points[nextPoint][0], points[nextPoint][1]);
//drawPoint(recentLati, recentLongi);

var d=new Date();
strTime = d.getHours()+":" + d.getMinutes()+ ":" +d.getSeconds();
str = "時間:" + strTime;
//alert(str);
str += "<br />位置:" + recentLati.toFixed(7) + ", "+ recentLongi.toFixed(7);
//str += "<br />精確度" + evt.coords.accuracy;
str += "<br />目標:" + points[nextPoint][0];		//prevLati.toFixed(7) + ", " + prevLongi.toFixed(7);
str += "<br />距離:" + dist.toFixed(3) +"公里";
//prevLati = evt.coords.latitude;
//prevLongi = evt.coords.longitude;

document.getElementById("posStr").innerHTML=str;

//debugMsg += "geoYes()完成。";
document.getElementById("watchStr").innerHTML=debugMsg;
if (nextDist > preDist){
	nextPoint++;
	preDist = 0;
}else(
	preDist = nextDist;
)

/*
str = "https://maps.googleapis.com/maps/api/staticmap"+
        "?zoom=15&size=300x300&sensor=false&center=" + 
        evt.coords.latitude +","+ evt.coords.longitude+
        "&markers=color:red%7C"+evt.coords.latitude +","+
         evt.coords.longitude;
 document.getElementById("map").src = str;    //要附API Key才能用。
//Google Map 2018.07.16以後開始收費
document.getElementById("msg").innerText = str;
*/
}

function geoNo(evt){
//限https? win10本機檔用Chrome可開允許,但仍取得失敗。 手機note9待測
debugMsg += "GPS取得失敗。";
document.getElementById("watchStr").innerHTML=debugMsg;
}

var watchID;
function startGPS(){
	watchID = navigator.geolocation.watchPosition( geoYes, geoNo);

	document.getElementById("watchStr").innerHTML="GPS正在監控中...";
}

function stopGPS(){
	navigator.geolocation.clearWatch( watchID );
	document.getElementById("watchStr").innerHTML="GPS停止監控中...";
}

function getDistance(lat1, lon1, lat2, lon2) {
    //本函式來源 https://www.geodatasource.com/developers/javascript

    var radlat1 = Math.PI * lat1/180;
    var radlat2 = Math.PI * lat2/180;
    var theta = lon1-lon2;
    var radtheta = Math.PI * theta/180;
    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    if (dist > 1) {
        dist = 1;
    }
    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;  //不明常數
    dist = dist * 1.609344  //英浬轉公里

    return dist;

}
</script>
</html>