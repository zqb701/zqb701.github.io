<!doctype html>
<html lang=zh_tw.UTF-8 manifest="index.manifest">
<head>
	<meta charset="utf-8">
	<!-- 程式來源 https://blog.xuite.net/gkyo0510/wretch/242769650 -->
	<title>GPS02-2</title>
<script defer>
	//defer:資源載入後才執行, async同, 但不保證照順序, 空白則立即執行,
	//等同 window.addEventListener('load', function() {...}
    if ('serviceWorker' in navigator) {
		navigator.serviceWorker.register('sw.js')	//參數scope設定掌管範圍, 預設為???
		.then(reg => console.log('完成 SW 設定!', reg))
            .catch(err => console.log('Error!', err));
		//sw.js須為獨立檔案, 無法把程式全部塞在一個檔案。
		
		navigator.serviceWorker.addEventListener("message", function(event) {
			showMsg(event.data);
		});
    }
</script>
</head>

<body onload="init();" bgcolor="black" text="gray" topmargin="0" leftmargin="0">
	<f function HTML_body(){}/>
	<canvas id="canvas"></canvas>
	<font size="7">
	<p id="posStr">111222</p>
	</font>
	<font size="6">
	<p id="watchStr">監控狀態</p>
	</font>
	<input type="button" value="啟動GPS" onClick="startGPS();">
	<input type="button" value="停止GPS" onClick="stopGPS();">
	<br />
	<input type="button" value="更新快取" onClick="newCache();">
	<input type="button" value="通知測試" onClick="displayNotification();">
	
	<input type="file" multiple id="input" style='display:none;'>
	版本：18:15 2022年2月7日
</body>

<script memo="座標圖資">

//TODO 到指定網站下載gps檔(並cache)
function var_tasks(){ }//本行給notepad++的函式清單用(大引號不可靠在一起)
var tasks = [[
		[22.6660872645837,		120.50037043288955,	"工業路口","號誌",,"號誌"],
		[22.665707901738443,	120.5010424041541,	"69巷"],
		[22.66528466599206,		120.5017954343364,	"殺蛇溪", "號誌",,"號誌"],
		
		[22.665066241181687, 120.50217027304704, "民福路","號誌"],
		[22.6642219442753, 120.50369274070279, "民生校區",,, "號誌"],
		[22.66339089234732, 120.50520474477672, "菸廠路", "號誌"],
		
		[22.66279229323675, 120.50623662222313, "瑞民路口",,,"號誌"],
		[22.662224974588675, 120.50727148282286, "歸仁路口", "號誌",,"號誌"],
		[22.660783934931143, 120.50977659008726, "瑞屏街口",,, "號誌"],
		
		[22.65990848834937, 120.51121889337335, "和生路口","號誌",,"號誌"],
		[22.659470893607228, 120.51209569251994, "安心四橫巷", "號誌",,"號誌"],
		[22.65982669905339, 120.51235318458225, "田中巷口", "號誌",,"號誌"],
		
		[22.65956412062677, 120.5130726983204, "二橫巷","交流道",,"交流道"],
		[22.659505837597436, 120.5143833817605, "10號", "廁所"],
		[22.659390282100908, 120.51514639840148, "瑞光路口", "交流道"],
		
		[22.658030217493362, 120.514628916623, "國仁路口", "號誌"],
		[22.655579780727386, 120.51407578585876, "彎道"],
		[22.652150360224123, 120.51053770124854, "歸禮巷","交流道"],
		[22.651995666533377, 120.5111949090511, "彎01"],
		[22.651445528597453, 120.51110103173282, "彎02"],
		[22.65037439483884, 120.51412461031919, "歸義段", "廁所"]
	],[
		[22.658034247616996, 120.5146302173418,"國仁路口"],
		[22.659914735641667, 120.51117374021372,"屏商路口"],
		[22.65983459647982, 120.50578459146016,"歸仁彎"],
		[22.652905040831186, 120.49474121968251, "和生彎"],
		[22.651762313125314, 120.48597167701199, "復興路口"],
		[22.655823532381984, 120.46656980548235, "建國路口"],
		[22.642159446314253, 120.4185087722723, "磚仔窰"],
		[22.633618032191855, 120.38857434750723, "賓士路口"],
		[22.63635369740717, 120.38229941534014,"彎道1"],
		[22.635421093866388, 120.37318949926723, "彎道2"],
		[22.63413212059094, 120.37012392539445, "彎道3"],
		[22.63634876160687, 120.35721342010389, "文衡路"],
		[22.634581156634074, 120.35822752986832, "文衡彎道"],
		[22.63337989604311, 120.3579774601367, "文化路"],
		[22.633949053558847, 120.35468108635685, "大潤發"]	
	],[
		[22.659389112309576, 120.51514843327135,"田中巷口","號誌"],
		[22.66042539472848, 120.5153220745,"單車道", "號誌",,"號誌"],
		[22.661457518466925, 120.51546704670002, "瑞光彎道1"],
		[22.665190350620573, 120.51312797662538,"香揚巷口", "號誌",,"號誌"],
		[22.669040797908576, 120.51069667037709, "瑞光彎道2"],
		[22.673650031059577, 120.51056656006223, "田寮巷口", "號誌",,"號誌"],
		[22.675343791402256, 120.51041230398191, "瑞光彎道3"],
		[22.676452289680334, 120.50955647049913, "建豐路口", "號誌",,"號誌"],
		[22.680967230062606, 120.5055987046144, "瑞光彎道4"],
		[22.68296750430608, 120.50505775656028, "大連路口", "號誌",,"號誌"],
		[22.687119793082346, 120.50397282994732, "華正路口", "號誌",,"號誌"],
		
		[22.692732317780546, 120.50245954225517,"海豐街", "號誌",,"號誌"],
		[22.695511971450234, 120.5054161117716,"盛豐路", "號誌",,"號誌"],
		[22.697465730730798, 120.5124731605147,"盛豐彎道1"],
		[22.701213109756527, 120.51893681604922,"盛豐彎道2"],
		[22.70880261417915, 120.52199195978083, "德和路", "號誌",,"號誌"],
		[22.7151486520024, 120.52903378461157, "海豐交流道", "號誌",,"號誌"],
		
		[22.749973605486066, 120.49659819389186,"九如交流道北上","交流道"],
		[22.755737015999156, 120.4862825614745,"九如交流道南下",,,"交流道"],
		[22.77964242423787, 120.427908073193665,"燕巢系統北上","交流道"],
		[22.794471334710444, 120.42609095864529,"燕巢系統南下",,,"交流道"],	//接國10匣道加長
		[22.972969515201683, 120.33025066426973,"關廟系統北上","交流道"],
		[23.026761370636468, 120.32717946883794,"新化休息站北上","廁所"],
		[23.055614880035566, 120.3213650686524,"新化系統北上","交流道"],
		[23.160111264166215, 120.34888474924794,"官田系統北上","交流道"],
		[23.259032533296, 120.3761323379591,"柳營交流道北上","交流道"],
		
		[23.270214334942427, 120.37907987648953,"閘道","急彎"],
		[23.26791494025789, 120.38048922441678,"165路口","號誌"],
		[23.27072646483229, 120.38336295538674, "旭山路口","號誌",,"號誌"],
		[23.283454163556105, 120.3834169629939, "義士路口","號誌",,"號誌"],
		[23.29493901838239, 120.38556569359515, "東河路口","號誌",,"號誌"],
		[23.318507349252233, 120.40299714640597, "公園路口","號誌",,"號誌"],
		[23.321184332623805, 120.40322488355994, "民有街口"],
		[23.32108328032145, 120.40447735836689, "民有街","廁所"]
		
	],[

		[22.66870485598517, 120.48572274512632,"台鐵屏東南二門","廁所"],
		[22.668258854960587, 120.48931283122437,"復興路口","號誌"],
		[22.666716941498812, 120.48890159338008, "自由復興路口","號誌"],
		[22.66616756924055, 120.4913256311424,"自由路彎道"],
		[22.669222036792192, 120.49452819798431, "民生自由路口","號誌"],
		[22.667523721107013, 120.4978306934891, "民生廣東路口","號誌"],
		[22.6660872645837,		120.50037043288955,	"工業路口","號誌",,"號誌"],
		[22.662224974588675, 120.50727148282286, "歸仁路口", "號誌",,"號誌"],
		[22.65990848834937, 120.51121889337335, "和生路口","號誌",,"號誌"],
		[22.658034247616996, 120.5146302173418,"國仁路口", "號誌"],
		[22.651514894343208, 120.52598275892676,"麟洛路口", "號誌"],
		[22.6400899784641, 120.53628286483544, "麟洛國中路口", "號誌"],

		[22.655381953796578, 120.55160925823591, "科大路口", "號誌",,"號誌"],
		[22.653958635505553, 120.56099718185452, "南豐路口","號誌",,"號誌"],
		[22.652601671108002, 120.56930340677384, "科大彎道"],
		[22.650020204517485, 120.57232527227198, "新生路口","號誌"],
		[22.64920952763707, 120.57317083867531,"新生路口",,,"號誌"],
		[22.644074768025085, 120.57842934867084, "測速",,,"測速"],
		[22.643333748129898, 120.57925428694658, "大同路口","號誌",,"號誌"],
		[22.634758245038586, 120.58804450981617, "科大北路","號誌",,"號誌"],
		[22.630047211459626, 120.59291416762996, "老埤路口", "號誌",,"號誌"],
		[22.633128880246172, 120.59797113670795, "安通路口", "號誌",,"號誌"],

		[22.62871783050417, 120.62638157350078,"沿山路口", "號誌",,"號誌"],
		[22.62210667218307, 120.62556054399592, "保安路口", "號誌",,"號誌"],
		[22.61246586071109, 120.6200526260988, "彎道"],
		[22.604416359284045, 120.62024646947125, "營區路口","號誌",,"號誌"],
		[22.59858233469853, 120.62046577629641, "測速","測速"],
		[22.591721713708438, 120.62115374455101, "佳平路口", "號誌",,"號誌"],
		
		[22.590483410935843, 120.62465695816196,"水泉山公園","急彎",,"急彎"],
		[22.592155787378577, 120.63335669509607,"消防隊","急彎",,"急彎"],
		[22.58972948061996, 120.63908090610973, "112基地"],
		[22.59007659798934, 120.64766077466638,"橋","急彎",,"急彎"],
		[22.582703739665064, 120.64590316103639, "彎道"],
		
		[22.58156375746854, 120.64774690725149,"急彎A","急彎",,"急彎"],
		[22.58345391607421, 120.64720794662499,"急彎B","急彎",,"急彎"],
		[22.580992567577628, 120.64849052598437,"急彎C","急彎",,"急彎"],
		[22.58305093602287, 120.64777911612705,"急彎D","急彎",,"急彎"],
		[22.57838760565134, 120.64971247385891,"坑洞","坑洞"],
		[22.5727629,120.6509855,"逍遙山莊","急彎",,"急彎"],
		
		[22.578508767064537, 120.65131389357563,"坑洞","坑洞",,"坑洞"],
		[22.58924109879525, 120.66460999148127, "大武山之門"],
		[22.593386038796442, 120.67046156816451, "返璞","坑洞",,"坑洞"],
		[22.59176168536461, 120.67935691835952,"舊佳平遺址","坑洞"],
		[22.595115994968776, 120.68506473873026, "觀自在"],
		[22.606633881440352, 120.69482779987918, "廁所","急彎",,"急彎"],
		[22.6145008,120.7017865,"武山停車場","廁所",]
	],[
		[22.666540670813557, 120.50113642730727, "民利路"],
		[22.66728729803525, 120.4997624132888, "民教路"],
		[22.668284731721105, 120.49808200934285, "廣東路"],
		[22.667523721107013, 120.4978306934891, "民生廣東路口","號誌"],
		[22.66566750271852, 120.4961204306436, "民有一路"],
		[22.664495102608665, 120.49399094587267, "台糖三街","號誌"],
		[22.66472029116734, 120.49111723281767, "台糖一街"],
		[22.662416069802465, 120.49028271413977, "台糖街"],
		[22.66159915133573, 120.49302542015064, "台糖三街2","廁所"]
	]];
</script>

<script title="程式碼">

	var taskID = -1;
	var points = [];
	var mapPoints = [];
	var taskTitle = "";
	var zoom = -1;
	
	var nextPoint = 0;	//下一個點
	var Point01 = [22.659517486714293,120.51431010230766, "田中巷"];	
	var Point02 = 		[22.582703739665064, 120.64590316103639];
	var recentPoint = Point01;
	//上一個通過的點
	var passPoint = [0,0];
		passPoint[0] = recentPoint[0];
		passPoint[1] = recentPoint[1];
		
	var zoom0 = -1;
	var zoom1 = -1;
	
	var centerCoords0 = [23,120.5];
	var centerCoords = [23,120.5];
	
	var nextDist = -1;
	var shadowDist = -1;
	var preDist = 0;
// var heading = -1;	//目標的方向0~360(以前一目標計算,但初值以移動點計算)
	var pathAngle = -1;
	
	var receGap = 0;
	var prevGap = 0;
	//任務的去回行程, 回程為-1
	var vector = 1;	
	/** 一般提醒*/
	var enAlarm = true;
	/** 高速第一次提醒*/
	var enAlarmHigh = true;
	var canvas = document.getElementById("canvas");
	//canvas.addEventListener("click", click, false);

    canvas.addEventListener('mousedown',mouseDown);
	canvas.addEventListener('mousemove',mouseMove);
	canvas.addEventListener('mouseup',mouseUp);
	
	canvas.addEventListener('touchstart',touchStart);
    canvas.addEventListener('touchmove',touchMove);
    canvas.addEventListener('touchend',touchEnd);

	var enGestures = false;
	
	var ctx = canvas.getContext("2d");

	canvas.width = 950;canvas.height = 950;		//寬高預設值為300×150
	// canvas.width = window.innerWidth;
	// canvas.height = canvas.width;
	var centerX = canvas.width  / 2;
	var centerY = canvas.height / 2;
	

	//var scrPoint = gps2scr(recentPoint);
	const voice = new Audio();
	//voice.volume = 0.5;//預設值為何?

	 var startGestX = -1;
	var startGestY = -1;

	var oldClickTimes = -1;
	var viewMode = 1;
	
	
function init(){
	showMsg("start init()");
	if( navigator.geolocation ) {
		navigator.geolocation.getCurrentPosition( geoYes, geoNo);
	}else {
		showMsg("navigator.geolocation物件失敗。");
	}
	//file://即使同意, 仍然禁止
	/*
	if ('Notification' in window) {
		Notification.requestPermission(function(status){
			console.log('User Choice', status);
			if (status !== 'granted') {
				console.log('推播允許被拒絕了!');
			} else {

			}
		});
	new Notification('訂閱成功！！！');
	}
	*/
	newTask();
	newSpace();

	startGPS();
	noSleep();	//note 9 上, chrome有效, 三星無效

	drawClearMap();
	drawBaseMap();
		nextDist = getDistance(recentPoint,  points[nextPoint]);
		newDist2 = Math.cos(2*Math.PI *150/360 - Math.atan((recentPoint[1]- points[nextPoint][1])/(recentPoint[0] - points[nextPoint][0])))*nextDist;
	console.log(nextDist + ", " + newDist2);
	showData();

}

function newSpace(){	
/**計算適當的繪圖位置
	找出所有點分佈範圍的邊界值, 算中心點及比例
*/
 /*
 for(p in points){
	points[p][0] = Math.round(points[p][0], 5);
	points[p][1] = Math.round(points[p][1], 5);
 }
 */
 	//找出四邊的點以算出放大值zoom
var maxN = points[0][0];
var maxS = points[0][0];
var maxE = points[0][1];
var maxW = points[0][1];

for(p in points){
	if(points[p][0] > maxN) maxN = points[p][0];
	if(points[p][0] < maxS) maxS = points[p][0];
	if(points[p][1] > maxE) maxE = points[p][1];
	if(points[p][1] < maxW) maxW = points[p][1];
}

	if((maxN - maxS) >(maxE - maxW)){	//比較長與寛,較大者的拿來算比例
		zoom = canvas.height * 0.9/(maxN - maxS);
	}else{
		zoom = canvas.width * 0.9/(maxE - maxW);
	}
	zoom0 = zoom;
	centerCoords0[0] = (maxN + maxS)/2;
	centerCoords0[1] = (maxE + maxW)/2;

	centerCoords[0] = centerCoords0[0];
	centerCoords[1] = centerCoords0[1];
}

function touchStart(e){
	gesturesStart(e.targetTouches[0].pageX,e.targetTouches[0].pageY);
	e.preventDefault();//避免觸發 click()
}

function mouseDown(e){
	gesturesStart(e.pageX, e.pageY);
	e.preventDefault();
}

function gesturesStart(x,y){
//	showMsg("gesturesStart()");
		//手勢起始位置在九宮格中央才會運作
		var recentTime = new Date().getTime();
		
		if(x > canvas.width/3 && x <canvas.width*2/3 && y > canvas.height/3 && y < canvas.height*2/3){
				//上一行以乎可以用inner區塊的方法
			if(recentTime - oldClickTimes < 300){		//double click的間隔
				//縮放模式
				enGestures = true;
//				console.log("enGestures=" + enGestures);
				zoom1 = zoom;
				//ctx.beginPath();
				//ctx.moveTo(x, y);
				startGestX = x;
				startGestY = y;
			}else{
				//移動模式
			
			}
		}
		//移動
}

	var endGestX = -1; 
	var endGestY = -1;
function gesturesMove(x, y){
//	showMsg("gesturesMove()");
	endGestX = x;
	endGestY = y;
	if(enGestures && zoom>= zoom0/3){		//縮小不能小於1/3。那放大呢???
		 drawClearMap();
		 zoom =zoom1 *(1+(y-startGestY)*0.01);
		 if(zoom < zoom0/3)zoom = zoom0/3;
		 drawBaseMap();
	 }
}
function touchMove(e){
	gesturesMove(e.targetTouches[0].pageX,e.targetTouches[0].pageY);
	e.preventDefault();
}

function mouseMove(e){
	gesturesMove(e.pageX,e.pageY);
	e.preventDefault();
}

function gesturesEnd(){
	if(enGestures){
		enGestures = false;
	}else{
		gridCmd(endGestX, endGestY);
	}
}

function touchEnd(e){
	gesturesEnd();
	e.preventDefault();
}

function mouseUp(e){
	gesturesEnd();
	e.preventDefault();
}

async function noSleep(){	
//不自動休眠, Note9 chrome有效, 但三星browser無作用。
	// The wake lock sentinel.
	let wakeLock = null;
	// Function that attempts to request a screen wake lock.
	const requestWakeLock = async () => {
		try {
			wakeLock = await navigator.wakeLock.request('screen');
			wakeLock.addEventListener('release', () => {
				//console.log('Screen Wake Lock was released');
			});
		//console.log('Screen Wake Lock is active');
		//alert("NoSleep");
		} catch (err) {
			console.error(`${err.name}, ${err.message}`);
		}
	};
	// Request a screen wake lock…
	await requestWakeLock();

}


function click(e){	//觸發座標為滑鼠放開處
	e.preventDefault();
	document.getElementById("watchStr").innerHTML="click()";
	//var x = event.pageX;
	//var y = event.pageY;
	gridCmd(e.pageX, e.pageY);
}

function gridCmd(x,y){
//showMsg("gridCmd(), x=" + x +", y=" +y);
		var gridW = canvas.width/3;
		var gridH = canvas.height/3;
		oldClickTimes = new Date().getTime();
		
		if(x > gridW*2 && x < canvas.width-50 && y > gridH*2){	//右下角
		//&& x < canvas.width-50 用來避免note 9 的圓邊誤觸
			newTask();		
			playVoice("新任務");
			showData();
			return;
		}

		if(x > gridW*2 && x < canvas.width-50 && y < gridH){//右上角
			//&& x < canvas.width-50 用來避免note 9 的圓邊誤觸
			skipPoint();
			 
			// centerCoords[0] = points[nextPoint][0];
			// centerCoords[1] = points[nextPoint][1];
			// clearMap();
			// drawBaseMap();
			return;
		}
		
		if(x < gridW && x > 50 && y < gridH){//左上角
			//console.log("左上角_去回切換");
			if(vector ==1){
				vector = -1;//回程
				nextPoint = points.length-1;
				// document.getElementById("title").innerHTML="任務："+ taskTitle +"(回程)";
					playVoice("回程");
			}else{
				vector = 1;//去程
				nextPoint = 0;
				// document.getElementById("title").innerHTML="任務："+ taskTitle;
				playVoice("去程");
			}
			showData();
			return;
		}
		
		if(x < gridW && x > 50 && y > gridH*2){//左下角
			//console.log("左下角_測試音效");
			
			viewMode *= -1;		//兩種模式切換
			//showMsg(recentPoint[0]);
			if(viewMode == 1){
				playVoice("全圖");
				centerCoords[0] = centerCoords0[0];
				centerCoords[1] = centerCoords0[1];
				zoom = zoom0;
			}else{
				
				playVoice("置中");
				centerCoords[0] = recentPoint[0];
				centerCoords[1] = recentPoint[1];
				
				// centerCoords = [22.666085540968158, 120.50100909238924];
			}
			
			drawClearMap();
			drawBaseMap();
			return;
		}
	}
	
function playVoice(str){
	//語音來源：22/1/30雅婷文字轉語音下載wav檔, https://tts.yating.tw/
	//其它：google翻譯,可透過SoundOfText網站下載, 或自己用DevTools下載mp3
	if(str == undefined) return ;
	
	var fileName = "../voice/"+ str+".wav";
	//var fileName = str+".wav";
	//TODO : 錯誤處理, 讀檔失敗, 
	//console.log(fileName);
		voice.src = fileName;	//voice.setAttribute('src',fileName);
		voice.load();
	//TODO : 大檔可能要先load(), 再檢查可否撥放, 再catch 播放異常
		voice.play();
		showMsg(str);
}

function newTask(){
//任務切換
	nextPoint = 0;
	 nextDist = -1;
	preDist = 0;
	vector = 1;
	viewMode = 1;
	
	taskID ++;
	if (taskID == tasks.length) taskID = 0;
	points = tasks[taskID];
	
	
	newSpace();
	mapPoints = gps2scr(points);
	
	drawClearMap();
	drawBaseMap();
}	

function skipPoint(){
	enAlarm = true;
	enAlarmHigh = true;
	nextPoint += vector;
	if(nextPoint < 0 || nextPoint >=points.length){
		//playVoice("端點");
		showMsg("端點");
		return;
	}else{
		playVoice("通過");
		while(!points[nextPoint][4 - vector]){
			showMsg("略過" +points[nextPoint][2]);
			nextPoint += vector;
		}
		passPoint[0] = points[nextPoint - vector][0];
		passPoint[1] = points[nextPoint - vector][1];

	}
	showData();
}	

function drawClearMap(){
	ctx.fillStyle = "black";	//填滿色
	ctx.fillRect(0,0,canvas.width,canvas.height);
	ctx.strokeStyle = "blue";	//線條色
	ctx.lineWidth = 2;	//線條粗度
	ctx.strokeRect(0,0,canvas.width,canvas.height);
	ctx.strokeRect(canvas.width/3,canvas.height/3,canvas.width/3,canvas.height/3);

}

function drawMiddleCross(){
				//在畫面中央畫十字
		ctx.strokeStyle = "white";	//線條色
		ctx.lineWidth = "2";	//線條粗度
		ctx.beginPath();
		ctx.moveTo(centerX-20, centerY);
		ctx.lineTo(centerX+20, centerY);
		ctx.moveTo(centerX, centerY-20);
		ctx.lineTo(centerX, centerY+20);
		// start = Math.PI*(evt.coords.heading/180 - 0.5);
		// ctx.arc( centerX, centerY,10,start,start-Math.PI*2,true);
		ctx.stroke();
	
}
function drawBaseMap(){
	// mapPoints = gps2scr(points);
	
     var circle = new Path2D();		//綠色節點
	 var circle0 = new Path2D();	//紅色節點, 有語音者
	 var circle2 = new Path2D();	//所有節點中間填滿黑色
	 var path = new Path2D();
	 
 	for ( p=0;p< mapPoints.length;p++){		//TODO 改用Path2D物件
			if(points[p][3] == undefined){
				circle.moveTo(mapPoints[p][0], mapPoints[p][1]);
				circle.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
			}else{
				circle0.moveTo(mapPoints[p][0], mapPoints[p][1]);
				circle0.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
			}
			circle2.moveTo(mapPoints[p][0], mapPoints[p][1]);
			circle2.arc(mapPoints[p][0], mapPoints[p][1],5,0,Math.PI*2,true);
			path.lineTo(mapPoints[p][0], mapPoints[p][1]);
	}
	ctx.lineJoin="round";	//轉折點的樣式, miter(default), round扇形
	ctx.strokeStyle = "green";	//線條色
	ctx.lineWidth = 10;	//線條粗度
	ctx.stroke(path);
		  
	ctx.lineWidth = 3;	//線條粗度
	ctx.stroke(circle);
	  
	ctx.strokeStyle = "red";	//線條色
	ctx.stroke(circle0);
	  
	ctx.fillStyle = "black";
	ctx.fill(circle2);
	/*
	ctx.lineJoin="miter";	//轉折點的樣式, miter(default), round扇形 和 bevel三角形
ctx.miterLimit=5;		//最大斜接長度。斜接長度指的是在兩條線交匯處內角和外角之間的距離。

lineCap 線條端點的樣式, butt(default)方形, square 和 round圓形
setLineDash 方法和 lineDashOffset 屬性來制定虛線樣式
來源 https://kknews.cc/zh-tw/code/6azm5bl.html
	*/
}

function gps2scr(sourcePs){
	//經緯度座標「批次」轉螢幕座標
	//「假設」經緯度間隔等比例
	//但到時圖片貼上就偏了...
	var newPs=new Array();
	for(var i=0; i<sourcePs.length; i++){
		newPs[i] = new Array();
		newPs[i][0] =  (sourcePs[i][1] - centerCoords[1] )* zoom + centerX;
		newPs[i][1] = -(sourcePs[i][0] - centerCoords[0] )*zoom + centerY;
	}
	return newPs;
}

function drawPoint(lat, lon, color, width){
	var drawX = (lon - centerCoords[1] )* zoom + centerX;
	var drawY = -(lat - centerCoords[0] )*zoom + centerY;
	//console.log(drawX + "," + drawY);
	ctx.strokeStyle = "red";	//線條色
	ctx.lineWidth = "1";	//線條粗度
	ctx.beginPath();
    ctx.arc(drawX, drawY,1,0,Math.PI*2,true);
	ctx.stroke();
}

function geoYes(evt){
	recentPoint[0] = evt.coords.latitude;
	recentPoint[1] = evt.coords.longitude;

	if(viewMode == 1){		//全圖：只畫點
		drawPoint(recentPoint[0], recentPoint[1]);
	}else{		//置中：全重畫, 不畫點
		centerCoords[0] = recentPoint[0];
		centerCoords[1] = recentPoint[1];
		drawClearMap();
		drawMiddleCross();
		drawBaseMap();		
	}
	
	nextDist = getDistance(recentPoint,  points[nextPoint]);
	
	//投影距離無法適用較大的轉角, 還是要用分角線y=ax+b
	angle1 = Math.atan((recentPoint[0]- points[nextPoint][0])/(recentPoint[1] - points[nextPoint][1]));
	shadowDist = Math.sin(angle1- pathAngle) * nextDist;	//用sin則為與路中線的距離
					
	showData(evt);
	
		//時速90以上(高速公路, 開80不提醒?), 2公里前第一次提醒
	if(enAlarmHigh && nextDist < 2 && evt.coords.speed >25){
		playVoice(points[nextPoint][3]);
		enAlarmHigh = false;
		return;
	}
	/** 事前提醒*/
	//時速60公里 = 60x1000/60x60 = 60/3.6 = 16.6公尺/秒(步行4公里/小時)
	//車速每10公里提前2秒通知：
	//		120公里提前24秒, 33*24=792
	//		30公里時提前6秒通知,約8.1*6=48公尺。
	//		15公里,3秒,約4.1*3公尺,。
	
	//最後加10公尺給單車時,路中與路邊的距離補償用
	minDist = evt.coords.speed/1000 * evt.coords.speed*3.6/10*2 + 0.01;
	if(enAlarm  && nextDist < minDist){
			playVoice(points[nextPoint][3]);
			enAlarm = false;
			return;
	}
	/**判定為通過*/
	//a.近距離內距離變大。依車速修正
	//b.距離增加超過3次(至少要3秒?)
	//c.從分角線的一邊到另一邊(距離從正變負數, 所以相乘為負)
	receGap = nextDist - preDist;
	// if(receGap * prevGap < 0){//定位誤差會觸動
	if (nextDist > preDist && nextDist < evt.coords.speed/1000 * 2 + 0.01 ){
	//靠近時gap會小於零, 遠離時會大於零,變換時一正一負,相乘為負
		skipPoint();
		preDist = getDistance(recentPoint,  points[nextPoint]);
		pathAngle =  Math.atan((passPoint[0]- points[nextPoint][0])/(passPoint[1] - points[nextPoint][1]));
		// prevGap = 0;
	}else{
		preDist = nextDist;
	}
	prevGap = receGap;
}

function geoNo(evt){
	/*
		限https? win10本機檔用Chrome可開允許,但仍取得失敗。 手機note9待測
		Only secure origins are allowed 安全來源才可用geo...
		https://kknews.cc/zh-tw/tech/4qgkxq2.html
	*/

	showMsg(evt.code + ", " + evt.message);
}

var watchID;
function startGPS(){
	var options = {
	  enableHighAccuracy: true,	//高精度, 實測更新間隔約1秒, 否則約20秒。
	  //timeout: 5000,						//在note9用chrome會Timeout expired。
	  maximumAge: 0
	};
	watchID = navigator.geolocation.watchPosition( geoYes, geoNo, options);

	//showMsg("啟用GPS。");
}

function stopGPS(){
	navigator.geolocation.clearWatch( watchID );
	showMsg("停止GPS。");
}

function getDistance(coord1, coord2) {
	//兩座標間的距離, 傳回：單位公里, 小數點後三位
    //本函式來源 https://www.geodatasource.com/developers/javascript
	lat1 = coord1[0].toFixed(5);	//用小數5位算距離
	lon1 = coord1[1].toFixed(5);
	lat2 = coord2[0].toFixed(5);
	lon2= coord2[1].toFixed(5);
	
    var radlat1 = Math.PI * lat1/180;
    var radlat2 = Math.PI * lat2/180;
    var theta = lon1-lon2;
    var radtheta = Math.PI * theta/180;
    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    if (dist > 1) {
        dist = 1;
    }
    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;	//不明常數
    dist = dist * 1.609344 ;		//英浬轉公里

    return dist.toFixed(3);		//小數點後三位(四捨「六入」)
}

function showData(evt){
	str = "任務：" + points[0][2] + " - " + points[points.length-1][2];
	if(vector == -1){
		str += "(回程)";
	}
	str += "<br />目標：" + points[nextPoint][2];
	
	if(evt == undefined){
		str += "<br />距離：<br />時速：";
	}else{
		str += "<br />距離：" + nextDist  + "公里(" + shadowDist.toFixed(3) +")。";
		//alert(str);
		//str += "<br />位置：" + recentPoint[0] + ", "+ recentPoint[1];
		str += "<br/>時速："+ (evt.coords.speed*3.6).toFixed(1) + "公里。";	//原單位：米/秒
		str += "方向：" + Math.round(evt.coords.heading);	//方向為正北的順時針
		var d=new Date();
		strTime = d.getHours()+":" + d.getMinutes()+ ":" +d.getSeconds();		//+"."+d.getMilliseconds;
		str += "<br/>時間：" + strTime;
	}

	//	str += "("+ points[nextPoint][0] +", " + points[nextPoint][1];
	
	document.getElementById("posStr").innerHTML=str;
}

var msgList = ["","","","",""];
var msgID = 0;
function  showMsg(str){
	msgList[msgID] = str;
	output = msgList[msgID] + "<br/>";

	for(i=msgID+1; i < msgList.length; i++){
		output += msgList[i] + "。";
	}
	for(i=0; i < msgID; i++){
		output += msgList[i] + "。";
	}
	// console.log(output);
	document.getElementById("watchStr").innerHTML= output;
	
	msgID --;	//新的訊息放前面
	if(msgID < 0){
		msgID = msgList.length - 1;
	}
}

function newCache(){
	//將"gps"快取中的key全部刪除
	caches.open('gps')
		.then(function(cache) {
			cache.keys()
			.then(function(keys) {
				keys.forEach(function(request, index, array) {
					cache.delete(request);
				});
			});
		});
		
}

function displayNotification(){
    if('serviceWorker' in navigator){
        var options = {
            body: '歡迎進入30天PWA的世界'           
        };
        navigator.serviceWorker.ready
            .then(function(sw){
                sw.showNotification('訂閱成功！！！', options);
            })
    }  else{
		
	}
     
}


// document.getElementById('input').click();
// fileInput.onchange = () => {
  // const selectedFiles = [...fileInput.files];
  // console.log(selectedFiles);
// }
</script>
</html>