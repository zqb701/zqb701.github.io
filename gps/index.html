<!doctype html>
<html lang=zh_tw.UTF-8 manifest="index.manifest">
<head>
	<meta charset="utf-8">
	<!-- 程式來源 https://blog.xuite.net/gkyo0510/wretch/242769650 -->
	<title>GPS02-2</title>
</head>

<style>  
	.cmdButton {
		width:200px;
		height:200px;
		border-width:3px;
		border-style:dashed;
		border-color:#FFAC55;
		padding:5px;
		
		text-align:center;	//水平置中
		top:0px;
		line-height:200px;//文字垂直置中(行高等於容器高度),單行適用
	}  
</style>  

<body onload="init();" bgcolor="black" text="white" margin="0">
	<f function HTML_body(){}/>
	<a>版本：025</a>
	<input type="button" value="測試" onClick="test02();">
	<br>
	<canvas id="canvas"></canvas>
	<font size="7">
	<div style="display: flex; justify-content: flex-end;">
		<div class="cmdButton" onclick="insertCoord('坑洞');" >坑洞</div>
		<div class="cmdButton" onclick="insertCoord('急彎');">急彎</div>  
		<div class="cmdButton" onclick="insertCoord('測速');">測速</div>
		<div class="cmdButton" onclick="nearPoint();initTask();playVoice('新任務');">尋標</div>
		<div class="cmdButton" ><div id="march" onclick="swColor();">0</div></div>
	</div>
		
	<p id="posStr">111222</p>
	</font>
	<font size="6">
	<p id="watchStr">監控狀態</p>
	</font>
	<input type="button" value="GPS啟動" onClick="startGPS();">
	<input type="button" value="GPS停止" onClick="stopGPS();">
	<input type="button" value="更新快取" onClick="newCache();">
	<input type="button" value="通知測試" onClick="displayNotification();">
	<input type="button" value="清除軌跡數據" onClick="ins.innerHTML='';localStorage.insertCoord='';">
	
	<input type="button" value="匯出" onClick="exportCoord();">
	<input type="file" multiple id="input" style___='display:none;'>
	
	<p id="insertCoord"></p>
</body>
<script defer>
	//defer:資源載入後才執行, async同, 但不保證照順序, 空白則立即執行,
	//等同 window.addEventListener('load', function() {...}
    if ('serviceWorker' in navigator) {
		navigator.serviceWorker.register('sw.js')	//參數scope設定掌管範圍, 預設為???
		.then(reg => console.log('完成 SW 設定!', reg))
            .catch(err => console.log('Error!', err));
		//sw.js須為獨立檔案, 無法把程式全部塞在一個檔案。
		
		navigator.serviceWorker.addEventListener("message", function(event) {
			showMsg(event.data);
		});
    }
</script>
<script>
//TODO 到指定網站下載gps檔(並cache)
function var_tasks(){ }//本行給notepad++的函式清單用(大引號不可靠在一起)
var tasks = [[																	//廣東路
		[22.683493730273277, 120.49835715263679, "廣東路_仁愛路口","號誌",,"號誌"],
		
		[22.681135369442668, 120.50103519150333, "大連路","號誌",,"號誌"],
		[22.680503680227538, 120.50166215785417, "468巷","號誌",,"號誌"],
		[22.68001666152951, 120.50172601825584, "456巷","號誌",,"號誌"],
		[22.67709462074551, 120.50092146003797,"建豐路","號誌",,"號誌"],
		[22.676454250884152, 120.50072968208876, "勝利路","號誌",,"號誌"],
		[22.676016199057848, 120.50058752501798, "高豐街","號誌",,"號誌"],
		[22.674161811466448, 120.49996566902554,"民學路","號誌",,"號誌"],
		[22.671873370117144, 120.49922917511516, "公園路","號誌",,"號誌"],
		[22.671026831904392, 120.49895754739023,"林森路","號誌",,"號誌"],
		[22.670303645732268, 120.4987238326765, "民和路","號誌",,"號誌"],
		[22.669749249959157, 120.49854948908974, "師校巷","號誌",,"號誌"],
		[22.668284679096782, 120.49808161964651, "民利路","號誌",,"號誌"],
		
		[22.667523721107013, 120.4978306934891, "民生路","號誌",,"號誌"],
		[22.666146373148113, 120.49682535519977, "永興巷","號誌",,"號誌"],
		[22.66566842646139, 120.49611878921134, "民有一路","號誌",,"號誌"],
		[22.66449445724402, 120.49398889788802, "台糖三街","號誌",,"號誌"],
		[22.66453848649853, 120.4927585499102, "台糖二街","號誌",,"號誌"],
		[22.66471906690055, 120.49111327623315, "台糖一街","號誌",,"號誌"],
		[22.664921862823768, 120.49002489997704, "仁愛路","號誌",,"號誌"],
		[22.66524429343796, 120.4884874696773, "廣東南路_復興路口","號誌",,"號誌"]
	],[
		[22.66870485598517, 120.48572274512632,"台鐵南二門","休息站"],
		[22.668258854960587, 120.48931283122437,"復興路口","號誌"],
		[22.666716941498812, 120.48890159338008, "自由復興路口","號誌"],
		[22.66616756924055, 120.4913256311424,"自由路彎道"]
	],[
																					//民生路
		[22.67151428266995, 120.4783177394244, "民族和平路口","號誌",,"號誌"],
		[22.670291616624766, 120.4864197382896, "民族中正路口","號誌",,"號誌"],
		[22.67113062321537, 120.48921382369929, "民生逢甲路口","號誌",,"號誌"],
		[22.6703935686598,		120.49122460092052, "民權路","號誌",,"號誌"],
		[22.67008860646881,		120.49209548031308, "仁愛路","號誌",,"號誌"],
		[22.669222036792192, 120.49452819798431, "自由路","號誌",,"號誌"],
		[22.669049328652985, 120.49498868304266, "自立路","號誌",,"號誌"],
		[22.668690566737276, 120.49578050428205, "民和路","號誌",,"號誌"],
		[22.667523721107013, 120.4978306934891, "廣東路","號誌",,"號誌"],
		[22.66665111203367, 120.49936391934412, "民教路","號誌",,"號誌"],
		[22.6660872645837,		120.50037043288955,	"工業路","號誌",,"號誌"],
		[22.665707901738443,	120.5010424041541,	"69巷","路口"],
		
		[22.66528466599206,		120.5017954343364,	"殺蛇溪", "號誌",,],
		[22.665066241181687, 120.50217027304704, "民福路",,,"號誌"],
		
		[22.6642219442753, 120.50369274070279, "民生校區","號誌",, "號誌"],
		[22.66339089234732, 120.50520474477672, "菸廠路", "號誌",,"號誌"],
		[22.66279229323675, 120.50623662222313, "瑞民路演藝廳",,,"號誌"],
		[22.662224974588675, 120.50727148282286, "歸仁路", "號誌",,"號誌"],
		[22.660783934931143, 120.50977659008726, "瑞屏街中油",,, "號誌"],
		
		[22.65990848834937, 120.51121889337335, "民生路_和生路口","號誌",,"號誌"]
																						//台一(往南)

		/*
	],[																					//田中巷
		[22.659470893607228, 120.51209569251994, "安心四橫巷", "路口",,"路口"],
		[22.65982669905339, 120.51235318458225, "田中巷口", "路口",,"路口"],	
		[22.65956412062677, 120.5130726983204, "二橫巷","測速",,"測速"],
		[22.659505837597436, 120.5143833817605, "2-10號", "休息站",, "休息站"],
		[22.659390282100908, 120.51514639840148, "瑞光路口", "路口",,"路口"],
		*/
	],[
		[22.652150360224123, 120.51053770124854, "歸禮巷","路口",,"路口"],
		[22.651995666533377, 120.5111949090511, "彎01"],
		[22.651445528597453, 120.51110103173282, "彎02"],
		[22.650827243046646, 120.51339330202197, "彎03"],
		[22.65037439483884, 120.51412461031919, "歸義段", "休息站"],
		[22.649837544510383, 120.51520394582404, "歸來魚池"]
	],[																						//台一
		[22.640091466178593, 120.5362835094121, "台1_信義路口", "路口",, "路口"],
		//[22.6400899784641,     120.53628286483544, "麟洛國中", "路口",, "路口"],	
		[22.64284588050273, 120.5338488670412, "長安巷", "號誌",,"號誌"],	
		[22.649322449799737, 120.52806492385191, "大同街", "號誌",,"號誌"],
		[22.650677214478804, 120.52685860645906, "民族路","號誌"],
		[22.65164196538594, 120.52577244459546,"測速照相",,,"測速"],
		[22.655539129939942, 120.51901611238941, "果菜市場","號誌",,"號誌"],
		[22.658034247616996, 120.5146302173418,"台1_瑞光路口","號誌",,"號誌"],
	],[																								//台1屏東
		[22.659911101873785, 120.51121459162805,"台1_民生路","號誌",,"號誌"],
		[22.659860060390763, 120.50601741683295,"歸仁路","號誌",,"號誌"],
		[22.657599206003407, 120.50209948590671, "台1工業路","號誌",,"號誌"],
		[22.654892831843018, 120.49793962803176, "工業六路","號誌",,"號誌"],
		[22.652838739424972, 120.49458501291548, "和生路567巷","號誌",,"號誌"],//中油彎道
		[22.651762313125314, 120.48597167701199, "復興路","號誌",,"號誌"],
		[22.6529643293841, 120.4784366247958, "建南路","號誌",,"號誌"],
		[22.653656922272166, 120.47563281122031,"武成街","號誌",,"號誌"],
		[22.65425210140771, 120.47318992350883, "山隆巷","號誌",,"號誌"],
		[22.655823532381984, 120.46656980548235, "建國路口","號誌",,"號誌"],
		[22.654545853790143, 120.46379049366499, "450巷","號誌",,"號誌"],
																									//台1高雄
		[22.642159446314253, 120.4185087722723, "磚仔窰","號誌",,"號誌"],
		[22.633618032191855, 120.38857434750723, "賓士路口","號誌",,"號誌"],
		[22.63635369740717, 120.38229941534014,"彎道1","號誌",,"號誌"],
		[22.635421093866388, 120.37318949926723, "彎道2","號誌",,"號誌"],
		[22.63413212059094, 120.37012392539445, "彎道3","號誌",,"號誌"],
		[22.63634876160687, 120.35721342010389, "文衡路","號誌",,"號誌"],
		[22.637814021315773, 120.34815701797821, "文濟路","號誌",,"號誌"],
		[22.636279400935546, 120.34443647973721, "澄清路","號誌",,"號誌"],
		[22.639148060257018, 120.32797290769224, "大順路","號誌",,"號誌"],		//台一
		[22.649777978147927, 120.32414352266113, "建功路","號誌",,"號誌"],		//大順路
		[22.655493701401024, 120.31541457156159, "民族路","號誌",,"號誌"],
		[22.656615104497494, 120.30881782253226, "大順自由路","號誌",,"號誌"]

	],[	
		[22.634581156634074, 120.35822752986832, "文衡彎道"],
		[22.63337989604311, 120.3579774601367, "文化路"],
		[22.633949053558847, 120.35468108635685, "大潤發"]	
		//接大順路
	],[																					//瑞光路
		[22.652150360224123, 120.51053770124854, "瑞光路_歸禮巷","路口",,"路口"],
		[22.653399707004777,120.51195347112373, "民生東路11巷","路口",,"路口"],
		[22.654285266265962,120.51290058024507, "歸智巷","路口",,"路口"],
		[22.655579780727386, 120.51407578585876, "彎道10"],
		[22.658030217493362, 120.514628916623, "國仁路口", "號誌",, "號誌"],
		[22.658633168724144, 120.51504245069331, "彎道(急診室)"],
		// [22.659389112309576, 120.51514843327135,"田中巷口","號誌"],
		[22.66042539472848, 120.5153220745,"單車道", "號誌",,"號誌"],
		[22.661457518466925, 120.51546704670002, "彎道20"],
		[22.665190350620573, 120.51312797662538,"香揚巷口", "號誌",,"號誌"],
		[22.669040797908576, 120.51069667037709, "彎道30"],
		[22.670996612762544, 120.51062443057785, "民學路", "號誌",,"號誌"],
		[22.673650031059577, 120.51056656006223, "田寮巷", "號誌",,"號誌"],
		[22.675343791402256, 120.51041230398191, "彎道40"],
		[22.676452289680334, 120.50955647049913, "建豐路", "號誌",,"號誌"],
		[22.678966094896705, 120.50732545840168, "興豐路", "號誌",,"號誌"],
		[22.679781531852086, 120.50662226896395, "146巷", "號誌",,"號誌"],
		[22.680967230062606, 120.5055987046144, "彎道60"],
		[22.68296750430608, 120.50505775656028, "大連路", "號誌",,"號誌"],
		[22.68489551063569, 120.50453366820194, "17弄", "號誌",,"號誌"],
		[22.687119793082346, 120.50397282994732, "華正路口", "號誌",,"號誌"],
		[22.689404000290573, 120.50339964016158, "華新路", "號誌",,"號誌"],
		[22.6925738066444, 120.50228411988692, "中正路", "號誌",,"號誌"],
		[22.6975656929976, 120.49934616305569,"瑞光路_忠孝路", "號誌",,"號誌"]
	],[																					//海豐
		[22.692732317780546, 120.50245954225517,"海豐街", "號誌",,"號誌"],
		[22.695511971450234, 120.5054161117716,	 "盛豐路", "號誌",,"號誌"],
		[22.696883960767217, 120.50906180826027,"18巷", "號誌",,"號誌"],
		[22.698434438925595, 120.5144862524928,	 "XX巷", "號誌",,"號誌"],
		[22.701152592239588, 120.51891439357674, "彎道"],
		[22.702703598302563, 120.51973392246246, "屏34", "號誌",,"號誌"],
		[22.705400301590082, 120.52084164949027, "屏XX", "號誌",,"號誌"],
		[22.70880261417915,	 120.52199195978083, "德和路", "號誌",,"號誌"],
		[22.7151486520024,	 120.52903378461157, "海豐交路口", "號誌",,"號誌"]
	],[																					//國三
		[22.638461295240916, 120.5377207690429, "國3_麟洛"],
		
		[22.651404539183083, 120.5461149478058, "麟洛南下",,,"交流道"],
		[22.68493499943817, 120.56275716716313, "彎道35"],
		[22.696340598015862, 120.5553899586657, "長治"],
		[22.715142111757505, 120.52903480114699, "鹽埔"],
		[22.749973605486066, 120.49659819389186,"九如交流道北上"],
		[22.75358750782007, 120.49164156529784, "九如"],
		[22.755737015999156, 120.4862825614745,"九如交流道南下"],
		[22.757305544217772,120.477065673226,"測速照相11","測速"],
				[22.77964242423787, 120.427908073193665,"燕巢系統北上"],
		[22.794471334710444, 120.42609095864529,"燕巢系統南下"],	//接國10匣道加長
		// [22.80585998314831, 120.4259803891489, "中寮隧道南"],		/進入隧道後收不到GPS
		// [22.820521633065738, 120.42018369276356, "中寮隧道北"],
		[22.844973482678757,120.38563347460189,"測速照相22","測速"],
		[22.85886879087182, 120.37342920505114, "田寮收費站",,,"測速"],
		[22.880475806969113, 120.3605339960465, "田寮"],
		[22.924696124417068, 120.35079861529869, "關廟休北上"],
		[22.95513577884162, 120.35215292962923, "彎道46"],
		[22.972969515201683, 120.33025066426973,"關廟北上出口(台86)","交流道"],
		[22.976988169199117, 120.32451457757003, "關廟系統"],
		[23.002538936297594, 120.32017197763913, "彎道354k路橋"],
		[23.026761370636468, 120.32717946883794,"新化休息站北上"],
		[23.055614880035566, 120.3213650686524,"新化系統北上(國8)","交流道"],
		[23.106145617196557, 120.32773179091218, "善化收",,,"測速"],
		[23.083334391223495,120.3292765621875,"測速照相33","測速"],
		[23.118324342283117, 120.32929310908567, "善化交北上"],
		
		[23.160111264166215, 120.34888474924794,"官田系統北上"],
		[23.200949352616856,120.35551792420067,"測速照相44","測速"],
		[23.212595587038756, 120.3559797848179, "六甲"],
		[23.259032533296, 120.3761323379591,"柳營交流道北上","交流道"],
		[23.286301971953765, 120.39631885788566, "東山休北上"],
		[23.32962490710023, 120.432161080154, "白河收費站",,,"測速"],
		[23.34062022508645, 120.43785061223615, "白河交流道北上","交流道"],
		[23.42578664993767, 120.46606805157481, "水上系統北上出口"],
		[23.44499391816726, 120.48255061130372, "國3_中埔交流道北上","交流道"]

	],[
		[23.485188208883738, 120.38434099171512, "國1_太保北上",,,"交流道"],
		[23.424581019743666, 120.35661493424698,"嘉義系統"],
		[23.35803491965871, 120.33825254669834, "新營收費站"],
		[23.339912448572896, 120.3121423175039, "新營休息站"],
		[23.30732464446435, 120.29080890577876, "新營"],
		[23.219142537160913, 120.23911067598834, "下營系統(台84)"],
		[23.191613212788408, 120.23620573095596, "麻豆南出","交流道"],
		[23.182400329087255, 120.23565584201334, "麻豆"],
		
		[23.117642743896905, 120.24356043591008, "安定"],
		[23.08579196837314, 120.25127435443811, "台南系統南向出口","交流道"],
		[23.079167471361096, 120.25221238322186, "台南系統315k(國8)"],
		[23.041946983666293, 120.25145678714567, "國1_永康"]

	],[
		[23.18240333534582, 120.2356561677857, "南176_麻豆交"],
		[23.179799407691796, 120.23053900160443, "工業路"],
		[23.174856531744215, 120.2057855628174, "龍興路"],
		[23.16934475464802, 120.2017015640541, "彎道"],
		[23.163948416334236, 120.18235471843579,"佳東路A"],
		[23.165389855077912, 120.17815692521748, "延平路"],
		[23.165718934097523, 120.17493202856102, "光復路"],
		
		[23.163125179670626, 120.17480113865406, "佳里文化路"],
		[23.162128254867287, 120.17478333728292, "和平街(日寶)","路口",,"路口"],
		[23.15994954649453, 120.1747423026192, "新生路"],
		[23.15512708599309, 120.17535125150587, "仁愛路(烤乳豬)","路口",,"路口"],
		[23.154039981314654, 120.1782238827777, "勝利路"],
		[23.15190687589858, 120.18429166612924, "台19_佳東路B","路口",,"路口"],
		[23.14311001950342, 120.19226738006638, "南44"],
		[23.138545848367894, 120.19571009815844, "南46"],
		
		[23.1275321125773, 120.20202702873107, "新興街","路口"],
		[23.125341523640007, 120.20272218610758, "南34"],
		[23.12260921554261, 120.20307028308838, "西港文化路_南173"],
		[23.121224241617547, 120.20330956078294, "慶安路"],
		[23.11991804712925, 120.20353841567966, "綠川廊道"],
		[23.117550419483656, 120.20388642230876, "忠孝街"],
		[23.11055841015665, 120.20379938803494,"南40"],
		// [23.1064023872731, 120.20573854832975, "西港大橋"
		[23.096615435545832, 120.20949306426802, "南132"],
		[23.089733294555394, 120.21015660371577, "台19_吉安路(國8迴轉)","路口"]
	],[
		[23.080413339742048, 120.19535923568306, "國8公學路124巷"],
		[23.0897370627603, 120.2101580927553, "新吉2k"],
		[23.089499448870555, 120.21743863605131, "新吉西出",,,"交流道"],
		[23.085446760720064, 120.22599288589873, "南178"],
		[23.079169875340224, 120.25221462582486, "台南系統6k(國1)",,,"交流道"],
		[23.062056434287467, 120.28155653737717, "新市9k(台1)"],
		[23.063892216800244, 120.31592546825931, "新化東向出口(國3)","交流道"],
		[23.064403971547915, 120.32385934603009, "新化系統14k(國3)"]
	],[
		[23.271338325253637, 120.3783841435445, "南165_柳營交流道南下",,,"路口"],
		[23.270214334942427, 120.37907987648953,"閘道","急彎"],
		[23.26791494025789, 120.38048922441678,"165路口","路口",,"路口"],
		[23.27072646483229, 120.38336295538674, "旭山路口","號誌",,"號誌"],
		[23.271978967066747, 120.38387977427587, "彎道33"],
		[23.283454163556105, 120.3834169629939, "義士路口","號誌",,"號誌"],
		[23.293512334998685, 120.38420249588806, "東河急彎"],
		[23.29493901838239, 120.38556569359515, "東河路口","號誌",,"號誌"],
		[23.307793557109218, 120.39991497924557, "北馬彎南","急彎"],
		[23.30941176650411, 120.39979334024561,"北馬彎北",,,"急彎"],
		[23.31062426006925, 120.40028523189007, "測速",,,"測速"],
		[23.318507349252233, 120.40299714640597, "公園路口","號誌",,"號誌"],
		[23.321184332623805, 120.40322488355994, "民有街口","路口"],
		[23.32108328032145, 120.40447735836689, "南165_東山民有街","休息站"]

	],[
		[22.640091466178593, 120.5362835094121, "屏37信義路口", "路口",, "路口"],
		[22.643808327710612, 120.54063160448442, "交流道口", "號誌"],
		//[22.646887968356193, 120.54422751976801, "彎道"],	//不在回程路線上
		[22.650260226458116, 120.54568906280016, "民生路口", "號誌",,"號誌"],
		[22.655381953796578, 120.55160925823591, "科大路口", "路口",,"路口"],
		[22.653958635505553, 120.56099718185452, "南豐路口","號誌",,"號誌"],
		[22.652601671108002, 120.56930340677384, "科大彎道"],
		[22.650020204517485, 120.57232527227198, "新生路口","號誌"],
		[22.64920952763707, 120.57317083867531,"新生路口",,,"號誌"],
		[22.644074768025085, 120.57842934867084, "測速照相",,,"測速"],
		[22.643333748129898, 120.57925428694658, "大同路口","號誌",,"號誌"],
		[22.634758245038586, 120.58804450981617, "科大北路","號誌",,"號誌"],
		[22.630047211459626, 120.59291416762996, "老埤路口", "路口",,"路口"],
		[22.63165203265637, 120.59484811574646, "156巷","號誌",,"號誌"],
		[22.6323789465293, 120.59747736025373, "南山路","號誌",,"號誌"],
		[22.633128880246172, 120.59797113670795, "安通路口", "路口",,"路口"],
		[22.634391091432605, 120.6010304853308,   "彎道45"],
		[22.633781195307613, 120.60403833875074,  "彎道40"],
		[22.634897661413778, 120.60941335733453,  "彎道35"],
		[22.633953055967723, 120.61298180239025,  "彎道30"],
		[22.63129446897867, 120.61666081562409,  "彎道26"],
		[22.631997564921065, 120.61860851239224, "彎道22"],
		[22.62871783050417, 120.62638157350078,"沿山路口", "路口",,"路口"],
		[22.62210667218307, 120.62556054399592, "保安路口", "號誌",,"號誌"],
		[22.61246586071109, 120.6200526260988, "彎道"],
		[22.604416359284045, 120.62024646947125, "營區路口","號誌",,"號誌"],
		[22.59858233469853, 120.62046577629641, "測速照相","測速"],
		[22.591721713708438, 120.62115374455101, "台185_佳平路口", "路口",,"路口"]
	],[	
																				//
		[22.591721713708438, 120.62115374455101, "屏120-1_佳平路口", "路口",,"路口"],																		
		[22.590483410935843, 120.62465695816196,"水泉山公園","急彎",,"急彎"],
		[22.592155787378577, 120.63335669509607,"消防隊","急彎",,"急彎"],
		[22.588965173008408, 120.6347857736698,"彎道c2"],
		[22.58463228957156, 120.63724489714178,"彎道c2"],
		[22.587393230911395,120.63840873003024,"水溝蓋21","坑洞",,"坑洞"],
		[22.58972948061996, 120.63908090610973, "112基地"],
		[22.59007659798934, 120.64766077466638,"橋","急彎",,"急彎"],
		[22.582703739665064, 120.64590316103639, "急彎01","急彎",,"急彎"],
		
		[22.58156375746854, 120.64774690725149,"急彎02","急彎",,"急彎"],
		[22.58345391607421, 120.64720794662499,"急彎03","急彎",,"急彎"],
		[22.580992567577628, 120.64849052598437,"急彎04","急彎",,"急彎"],
		[22.58305093602287, 120.64777911612705,"急彎05","急彎",,"急彎"],
		[22.57838760565134, 120.64971247385891,"坑洞03","坑洞",,"坑洞"],
		[22.571896220921186, 120.65036759528631,"逍遙山莊","急彎",,"急彎"],
		
		[22.578508767064537, 120.65131389357563,"坑洞04","坑洞",,"坑洞"],
		[22.587039118932154, 120.65992939675222,"急彎06","急彎",,"急彎"],
		[22.590629698135977, 120.65974713603376,"急彎07","急彎",,"急彎"],
		[22.590471544673793, 120.66264498498556,"急彎08","急彎",,"急彎"],
		[22.58924109879525, 120.66460999148127, "大武山之門","路口",,"路口"],
		[22.593386038796442, 120.67046156816451, "返璞","坑洞",,"坑洞"],
		[22.59176168536461, 120.67935691835952,"貨櫃屋","坑洞"],
		[22.592039093947136,120.6809451159679,"坑洞041","坑洞",,"坑洞"],
		[22.591599051656083, 120.68486212232875, "坑洞05","坑洞",,"坑洞"],
		[22.592177531280022, 120.68483357628378, "坑洞06-1","坑洞"],
		[22.592630575345552,120.68464827381979,"坑洞06-2",,,"坑洞"],
		[22.595115994968776, 120.68506473873026, "觀自在"],
		[22.598383562209477, 120.6845511475299,"彎道A3"],
		
		[22.606633881440352, 120.69482779987918, "空地","急彎",,"急彎"],
		[22.60692827794966, 120.69154676474011, "彎道A1"],
		[22.607947926654507, 120.691525188623,  "彎道A2"],
		[22.610869623490217,120.69874924464474,"坑洞07","坑洞",,"坑洞"],
		[22.6145008,120.7017865,"泰武停車場","休息站",,"休息站"],
		[22.615443681182708, 120.70262923538111, "泰武斷崖","坑洞"]
		
	],[																			//台86,關廟系統
		[22.97668452704216, 120.32249768738073, "台86_關廟匣道", "靠右"],
		[22.975157067181804, 120.31877334375743, "台19甲","號誌",,"號誌"],
		[22.971278480819183, 120.31327247513406, "測速","測速"],
		[22.94149314730315, 120.30124755313828, "彎道01"],
		[22.934595270792208, 120.26099575774114, "彎道上崙交流道"],
		[22.942623194631146, 120.24965817528305, "彎道仁德系統(國1)"],
		[22.932049664423836, 120.22499353058586, "湖內交流道東", "交流道"],
		[22.9314528036442, 120.22194023530919, "閘道"],
																						//台一(台南市)
		[22.937275501642834, 120.22099726418344, "文華路口", "號誌",,"號誌"],
		[22.941787731378756, 120.22095711150357, "彎道02"],
		[22.93992471408244, 120.2210067902625, "測速",,,"測速"],
		[22.94405536181032, 120.22033245507691, "文賢路口","號誌",,"號誌"],
		[22.952419382785543, 120.21798832077249, "亞航街前", "號誌"],
		[22.960437309262627, 120.21697996600106, "保仁路"],
		[22.964595069946935, 120.21645445767052, "生產路","號誌",,"號誌"],
		[22.972416153855065, 120.21481356468252, "中華路","號誌",,"號誌"],
		[22.97629414889348, 120.21394046244464, "大林路", "號誌",,"號誌"],
		// [22.9807394351853, 120.2123072481083, "大同路100巷", "路口"]
		[22.98093008588478, 120.21220250902789, "林森路", "號誌"],
		[22.981254574359404, 120.21202626011987, "林森路",,,"號誌"],
		[22.982520880136445, 120.21136638747849, "五妃街", "號誌",,"號誌"],
		[22.98458384518558, 120.21116379385018, "府連路", "號誌"],
		[22.98495731277926, 120.21114668393643, "開山路",,,"號誌"],
		[22.988484571746923, 120.21138271972436, "圓環", "號誌",,"號誌"]
		
	],[
																							//台南永成路
																							
		[22.932626829740283, 120.19559510868507,"永成路_台86","號誌",,"號誌"],
		[22.93911255293149, 120.19556448857217,"萬年路","號誌",,"號誌"],
		[22.95881038307809, 120.19547078885118,"興隆路","號誌",,"號誌"],
		[22.96231716768313, 120.19546142030968, "中華路","號誌",,"號誌"],
		[22.967216509000707, 120.19540367809161, "新都路","號誌",,"號誌"],
		[22.97493278871515, 120.19537816526025, "大成路","號誌",,"號誌"],
		[22.978259966041534, 120.19517997846175,"新興路","號誌",,"號誌"],
		[22.981469740961604, 120.19509075977518,"建康路","號誌",,"號誌"],
		[22.98384952235901, 120.19501272336689, "府緯街","路口",,"路口"],
		[22.983868041971245, 120.19566450015733, "115巷","號誌",,"號誌"],
		[22.983843349737928, 120.19645067939489, "國華街","路口",,"路口"],
																							//陳家伏苓糕
		[22.985122671604636, 120.1963768943332, "南寧街","路口",,"路口"],
		[22.98509651438787, 120.19757565593272, "西門路","路口",,"路口"],
		[22.986333154748692, 120.19755594081165, "樹林街","號誌",,"號誌"],
		[22.987401089922763, 120.19753782949647, "永華路","號誌",,"號誌"],
		[22.990429445535817, 120.1978096970032, "府前路","號誌",,"號誌"],
		[22.992738588587297, 120.1986183361251, "中正路","路口",,"路口"],
		[22.992251798658174, 120.20084298579434, "永福路","路口",,"路口"],
		[22.989942829042207, 120.20035038209184, "永福府前","路口",,"路口"],
		[22.98903709598085, 120.20460864379818, "南門路","號誌",,"號誌"],
		[22.988964914094694, 120.20765672145865, "開山路","路口",,"路口"],
		[22.98482402196842, 120.21112548826888, "大同路","路口",,"路口"]
	],[
																						//175白河到關嶺
		[23.34736177842498, 120.4447239149028,"東河路口", "號誌",,"號誌"],
		[23.35037578490617, 120.45197534909033, "虎子墓01", "號誌",,"號誌"],
		[23.352307148834168, 120.46367140205685,"虎子墓02", "號誌",,"號誌"],
		[23.352295278291262, 120.46795001308695, "南98白河水庫", "號誌",,"號誌"],
		[23.345975279208922, 120.47300827746007, "仙草外環", "號誌",,"號誌"],
		
		[23.344536783584005, 120.47493729997255, "南172乙仙草", "號誌",,"號誌"],
		[23.340355027385485, 120.49928365378014, "捷徑"],
		[23.340419604980966, 120.50247185780395, "白水橋"],
		[23.342090346811354, 120.50372659572749, "南175", "號誌",,"號誌"],
		[23.337751346472697, 120.50537706769376, "彎道"],
		
		[23.339344792930895, 120.50313343078629, "彎道"],
		[23.33638531525768, 120.50398936957284, "彎道"],
		[23.334149222954125, 120.50311720366186, "捷徑"],
		[23.33385015664403, 120.5033061215673, "頂關子嶺", "號誌",,"號誌"]
	],[
		[22.614245529733807, 120.70180073192317, "車輛入口"],
		[22.61501512803279,120.70223332448214,"步行入口","路口"],
		[22.615160672882556,120.70174126247534,"救難繩","路口"],
		[22.619745623676106,120.70154845769152,"水泥頂","路口"],
		[22.621937370512125,120.70367581710855,"休息站01","休息站"],
		[22.626309106974965,120.70441736305555,"休息站02","休息站"],
		[22.6291667, 120.7019444, "日湯真山"],
		[22.626969353569677,120.70990233858107,"崖頂"],
		[22.625096216539994,120.71220141454029,"宿舍叉路","路口"],
		[22.625370031788954,120.71345147109773,"宿舍旁","路口"],
		[22.6282578294187,120.71216937843494,"水源橋","休息站"],
		// [22.627910793033372,120.71205956643135,"廁所路口"],
		[22.624396684841113,120.71457908355855,"管制站路口","路口"],
		[22.6243669, 120.7148054, "管制站"],
		[22.621937370512125,120.70367581710855,"休息站01"]	//重畳點
	]];

	var taskID = 2;
	// var DEBUG = true;
		var DEBUG = false;
	var points = [];
	//var mapPoints = [];
	var taskTitle = "";
	var zoom = -1;
	
	var nextPoint = 0;	//下一個點
	var Point01 = [22.659517486714293,120.51431010230766, "田中巷"];	
	var Point02 = [22.66613321392555, 120.50085349955407,"一樓"];
	var recentPoint = Point01;
	//上一個通過的點
	var passPoint = [0,0];
		passPoint[0] = recentPoint[0];
		passPoint[1] = recentPoint[1];
		
	var zoom0 = -1;
	var zoom1 = -1;
	
	var centerCoords0 = [23,120.5];
	var centerCoords = [23,120.5];
	
	var nextDist = 0;
	var shadowDist = -1;
	var preDist = 0;
	var incDistCnt = 0;
// var heading = -1;	//目標的方向0~360(以前一目標計算,但初值以移動點計算)
	var pathAngle = -1;
	// 尋標,新任務或去回程切換時要開啟, 有GPS的狀態時依據當前座標找到最近點
	var searchPoint=true;
	
	var receGap = 0;
	var prevGap = 0;
	//任務的去回行程, 回程為-1
	var vector = 1;	
	/** 一般提醒*/
	var enAlarm = true;
	/** 高速提醒*/
	var enAlarmHigh = true;
	
	var canvas = document.getElementById("canvas");
	//canvas.addEventListener("click", click, false);

    canvas.addEventListener('mousedown',mouseDown);
	canvas.addEventListener('mousemove',mouseMove);
	canvas.addEventListener('mouseup',mouseUp);
	
	canvas.addEventListener('touchstart',touchStart);
    canvas.addEventListener('touchmove',touchMove);
    canvas.addEventListener('touchend',touchEnd);

	var enGestures = false;
	
	var ctx = canvas.getContext("2d");

	canvas.width = 950;canvas.height = 950;		//寬高預設值為300×150
	// canvas.width = window.innerWidth;
	// canvas.height = canvas.width;
	var centerX = canvas.width  / 2;
	var centerY = canvas.height / 2;
	

	//var scrPoint = gps2scr(recentPoint);
	const voice = new Audio();
	//voice.volume = 0.5;//預設值為何?

	 var startGestX = -1;
	var startGestY = -1;

	var oldClickTimes = -1;
	var viewMode = 1;
	
	var ins = document.getElementById("insertCoord");

	class TODO {}// function TODO(){}
	var _todo = new TODO();
	
	class canvas01{}
	var myCanvas = new canvas01();
	
	class map01{}
	var myMap = new map01();
	
	class control01{}
	var myCtl = new control01();
	/**
		
	*/
	function test02(){
		strGPS = strGPS.substr(1,3)+strGPS.substr(0,1);
		console.log(strGPS.substr(0,1));
		
	p0=	[22.665588375791046, 120.50101392899106,""];
		// [22.66654286222146, 120.50113602621077,"民利35巷"],
		p1=[22.665285944517155, 120.50179304264677,"殺蛇橋"];
		p2 = [22.66608654077297, 120.50036725372237,"工業路"];
	angleOffset(p0,p1,p2);
	}
function angleOffset(p0,p1,p2){		
	if(DEBUG) console.log("angleOffset(s)");
	
	pp = [[,],[,],[,]];
	pp[1][0] = p1[0];
	pp[1][1] = p0[1];
	d1y = getDistance(pp[1],p0);
	if(p1[0] < p0[0]){
		d1y *= -1;
	}
	d1x = getDistance(pp[1],p1);
	if(p1[1] < p0[1]){
		d1x *= -1;
	}
	
	pp[2][0] = p2[0];
	pp[2][1] = p0[1];
	d2y = getDistance(pp[2],p0);
	if(p2[0] < p0[0]){
		d2y *= -1;
	}
	d2x = getDistance(pp[2],p2);
	if(p2[1] < p0[1]){
		d2x *= -1;
	}
	// console.log(d1y,d1x,d2y,d2x)
	a1= Math.atan2(d1y,d1x);
	a2 = Math.atan2(d2y,d2x);
	
	dA = Math.abs(a1 - a2);
	// dA = Math.abs(dA - Math.PI);
	if(dA > Math.PI){
		dA = Math.PI*2 -dA;
	}
	// console.log(a1,a2,dA,dA*360/(2*Math.PI));	
	if(DEBUG) console.log("angleOffset(s), return:"+ dA);
	return dA;
}
	
	function test01(){
			p=[	[22.66654286222146, 120.50113602621077,"民利35巷"],
			[22.665285944517155, 120.50179304264677,"殺蛇橋"],
			[22.66608654077297, 120.50036725372237,"工業路"]];
	pp = [[,],[,],[,]];
	
	console.log(Math.atan(-1));
	pp[1][0] = p[0][0];
	pp[1][1] = p[1][1];
	// per1=	(p[1][1]-p[0][1]) / (p[1][0]-p[0][0]);
	per1=	getDistance( pp[1],p[0]) / -getDistance(pp[1],p[1]);
	
	an1 = Math.atan(per1);
		an1 = Math.atan2(-getDistance(pp[1],p[0]),getDistance( pp[1],p[1]))
	console.log(per1,an1);
	
	pp[2][0] = p[0][0];
	pp[2][1] = p[2][1];
	// per1=	(p[1][1]-p[0][1]) / (p[1][0]-p[0][0]);
	per2=	getDistance( pp[2],p[0]) / getDistance(pp[2],p[2]);
	an2 = Math.atan(per2);	

	console.log(per2,an2);
	// alert("stop!");

		
	}
	
function init(){
console.log("init(s)");
	// nextDist = 3.234;
	// showMsg(Math.round(nextDist));
	// showMsg(nextDist.toFixed());
		//file://即使同意, 仍然禁止
	/*
	if ('Notification' in window) {
		Notification.requestPermission(function(status){
			console.log('User Choice', status);
			if (status !== 'granted') {
				console.log('推播允許被拒絕了!');
			} else {

			}
		});
	new Notification('訂閱成功！！！');
	}
	*/

	startGPS();
	//保存最後任務編號
	// taskID = localStorage.taskID ? localStorage.taskID : taskID;
	initTask();
	// nearPoint();//	無GPS時測試用。
	newSpace();

	// startGPS();
	noSleep();	//note 9 上, chrome有效, 三星無效

	myCanvas.drawClearMap();
	myCanvas.drawBaseMap();
		nextDist = getDistance(recentPoint,  points[nextPoint]);
		newDist2 = Math.cos(2*Math.PI *150/360 - Math.atan((recentPoint[1]- points[nextPoint][1])/(recentPoint[0] - points[nextPoint][0])))*nextDist;
	//console.log(nextDist + ", " + newDist2);
	// showData();
console.log("init(e)");
}

function insertCoord(coordType){
	//	新增點, 插入陣列內, 陣列滙出, 5種新增鈕
	//console.log("insertCoord()");
		//document.getElementById("watchStr").innerHTML= output;
	playVoice('當');
	strtmp =  recentPoint[0]+","+recentPoint[1] + ",'自訂點','"+
		coordType +	"'," + 
		points[nextPoint][2]+
		"~"+ points[nextPoint-vector][2] +","+
		new Date().getHours()+":"+new Date().getMinutes() +":"+ new Date().getSeconds() +"<br/>" ;
		console.log(strtmp);
		
	// if (typeof (Storage) != "undefined"){
        // if (localStorage.insertCoord != "undefined"){
            //msg.innerText = localStorage.playVolume;
			localStorage.insertCoord = strtmp + localStorage.insertCoord;
            ins.innerHTML = localStorage.insertCoord;
		// }
	// }
	// }
	//showMsg(recentPoint[0].toFixed(7)+","+recentPoint[1].toFixed(7));
}

function newSpace(){	
/**計算適當的繪圖位置
	找出所有點分佈範圍的邊界值, 算中心點及比例
*/
 /*
 for(p in points){
	points[p][0] = Math.round(points[p][0], 5);
	points[p][1] = Math.round(points[p][1], 5);
 }
 */
 	//找出四邊的點以算出放大值zoom
var maxN = points[0][0];
var maxS = points[0][0];
var maxE = points[0][1];
var maxW = points[0][1];

for(p in points){
	if(points[p][0] > maxN) maxN = points[p][0];
	if(points[p][0] < maxS) maxS = points[p][0];
	if(points[p][1] > maxE) maxE = points[p][1];
	if(points[p][1] < maxW) maxW = points[p][1];
}

	if((maxN - maxS) >(maxE - maxW)){	//比較長與寛,較大者的拿來算比例
		zoom = canvas.height * 0.9/(maxN - maxS);
	}else{
		zoom = canvas.width * 0.9/(maxE - maxW);
	}
	zoom0 = zoom;
	centerCoords0[0] = (maxN + maxS)/2;
	centerCoords0[1] = (maxE + maxW)/2;

	centerCoords[0] = centerCoords0[0];
	centerCoords[1] = centerCoords0[1];
}

function touchStart(e){
	gesturesStart(e.targetTouches[0].pageX,e.targetTouches[0].pageY);
	e.preventDefault();//避免觸發 click()
}

function mouseDown(e){
	gesturesStart(e.pageX, e.pageY);
	e.preventDefault();
}

function gesturesStart(x,y){
//	showMsg("gesturesStart()");
		//手勢起始位置在九宮格中央才會運作
		var recentTime = new Date().getTime();
		
		if(x > canvas.width/3 && x <canvas.width*2/3 && y > canvas.height/3 && y < canvas.height*2/3){
				//上一行以乎可以用inner區塊的方法
			if(recentTime - oldClickTimes < 300){		//double click的間隔
				//縮放模式
				enGestures = true;
//				console.log("enGestures=" + enGestures);
				zoom1 = zoom;
				//ctx.beginPath();
				//ctx.moveTo(x, y);
				startGestX = x;
				startGestY = y;
			}else{
				//移動模式
			
			}
		}
		//移動
}

	var endGestX = -1; 
	var endGestY = -1;
function gesturesMove(x, y){
//	showMsg("gesturesMove()");
	endGestX = x;
	endGestY = y;
	if(enGestures && zoom>= zoom0/3){		//縮小不能小於1/3。那放大呢???
		 myCanvas.drawClearMap();
		 zoom =zoom1 *(1+(y-startGestY)*0.01);
		 if(zoom < zoom0/3)zoom = zoom0/3;
		 myCanvas.drawMiddleCross();
		 myCanvas.drawBaseMap();
	 }
}

function touchMove(e){
	gesturesMove(e.targetTouches[0].pageX,e.targetTouches[0].pageY);
	e.preventDefault();
}

function mouseMove(e){
	gesturesMove(e.pageX,e.pageY);
	e.preventDefault();
}

function gesturesEnd(){
	if(enGestures){
		enGestures = false;
	}else{
		gridCmd(endGestX, endGestY);
	}
}

function touchEnd(e){
	gesturesEnd();
	e.preventDefault();
}

function mouseUp(e){
	gesturesEnd();
	e.preventDefault();
}

async function noSleep(){	
//不自動休眠, Note9 chrome 92.0.4515.131有效, 但三星browser 16.0.6.23無作用。
	// The wake lock sentinel.
	let wakeLock = null;
	// Function that attempts to request a screen wake lock.
	const requestWakeLock = async () => {
		try {
			wakeLock = await navigator.wakeLock.request('screen');
			wakeLock.addEventListener('release', () => {
				//console.log('Screen Wake Lock was released');
			});
		//console.log('Screen Wake Lock is active');
		//alert("NoSleep");
		} catch (err) {
			console.error(`${err.name}, ${err.message}`);
		}
	};
	// Request a screen wake lock…
	await requestWakeLock();
}


function click(e){	//觸發座標為滑鼠放開處
	e.preventDefault();
	document.getElementById("watchStr").innerHTML="click()";
	//var x = event.pageX;
	//var y = event.pageY;
	gridCmd(e.pageX, e.pageY);
}

function gridCmd(x,y){
//showMsg("gridCmd(), x=" + x +", y=" +y);
	var gridW = canvas.width/3;
	var gridH = canvas.height/3;
	oldClickTimes = new Date().getTime();
	
	if(x > gridW*2 && x < canvas.width-50 && y > gridH*2){	//右下角
	//&& x < canvas.width-50 用來避免note 9 的圓邊誤觸
		// taskID ++;
		if (++taskID == tasks.length) {
			taskID = 0;
		}
		nextPoint = 0;
		initTask();
		playVoice("當");
		return;
	}

		if(x > gridW*2 && x < canvas.width-50 && y < gridH){//右上角
			//&& x < canvas.width-50 用來避免note 9 的圓邊誤觸

		playVoice("跳過");

			skipPoint();	//手動跳一點, 差太多點則切換方向重找最近點
			showData();
				//
			// searchPoint = true;
			return;
		}
		
		if(x < gridW && x > 50 && y < gridH){//左上角
			//console.log("左上角_去回切換");
			vectorMode();
			return;
		}
		
		if(x < gridW && x > 50 && y > gridH*2){	//左下角
			//console.log("左下角_測試音效");
			viewSW();
			return;
		}
	}

function vectorMode(){
	vector *=-1;
	nextPoint += vector;
	const vStr = ["回程",,"去程"];
	playVoice(vStr[1+vector]);
	showData();
}

function vectorMode_(){
	if(vector ==1){
		vector = -1;//回程
		nextPoint = points.length-1;
		playVoice("回程");
	}else{
		vector = 1;//去程
		nextPoint = 0;
		playVoice("去程");
	}
	// searchPoint =true;
	showData();
}

function viewSW(){
	viewMode *= -1;		//兩種模式切換
		myCanvas.drawClearMap();
	if(viewMode == 1){
		playVoice("全圖");
		centerCoords[0] = centerCoords0[0];
		centerCoords[1] = centerCoords0[1];
		zoom = zoom0;
	}else{		
		playVoice("置中");
		centerCoords[0] = recentPoint[0];
		centerCoords[1] = recentPoint[1];
		myCanvas.drawMiddleCross();
	}

	myCanvas.drawBaseMap();	
}

function playVoice(str){
	//語音來源：22/1/30雅婷文字轉語音下載wav檔, https://tts.yating.tw/
	//其它：google翻譯,可透過SoundOfText網站下載, 或自己用DevTools下載mp3
	if(str == undefined) return ;
	
	var fileName = "../voice/"+ str+".wav";
		voice.src = fileName;
		_todo._750找不到語音檔要報錯_並播放其它 = function(){}	//AAAAAAAA
		try {
			voice.load();
			voice.play();
		}catch (e) {	//完全抓不到error
			showMsg(e);
		}
}

function initTask(){
	//任務切換
	//nextPoint = 0;
	nextDist = -1;
	preDist = 0;
	incDistCnt = 0
	vector = 1;
	viewMode = 1;

	// localStorage.taskID = taskID;
	// taskID = localStorage.taskID ? localStorage.taskID-1 : taskID;
	

	points = tasks[taskID];
	
	newSpace();
	myCanvas.drawClearMap();
	myCanvas.drawBaseMap();
	
	showData();
}	

function skipPoint(){
		try{
	enAlarm = true;
	enAlarmHigh = true;
	

	passPoint[0] = points[nextPoint][0];
	passPoint[1] = points[nextPoint][1];
		
	nextPoint += vector;
	preDist = getDistance(recentPoint,  points[nextPoint]);
	


		if((nextPoint < 0 ) || (nextPoint == points.length)){
			nextPoint -= vector;
			showMsg("端點");
			searchPoint = true;
		}
	} catch (err) {
		showMsg(`${err.name}, ${err.message}`);
	}
}	

myCanvas.drawClearMap = function (){
	ctx.fillStyle = "black";	//填滿色
	ctx.fillRect(0,0,canvas.width,canvas.height);
	ctx.strokeStyle = "blue";	//線條色
	ctx.lineWidth = 2;	//線條粗度
	ctx.strokeRect(0,0,canvas.width,canvas.height);
	ctx.strokeRect(canvas.width/3,canvas.height/3,canvas.width/3,canvas.height/3);
}

myCanvas.drawMiddleCross = function(){
				//在畫面中央畫十字
		ctx.strokeStyle = "white";	//線條色
		ctx.lineWidth = "2";	//線條粗度
		ctx.beginPath();
		ctx.moveTo(centerX-20, centerY);
		ctx.lineTo(centerX+20, centerY);
		ctx.moveTo(centerX, centerY-20);
		ctx.lineTo(centerX, centerY+20);
		// start = Math.PI*(evt.coords.heading/180 - 0.5);
		// ctx.arc( centerX, centerY,10,start,start-Math.PI*2,true);
		ctx.stroke();
	
}

myCanvas.drawBaseMap = function(){
	 var mapPoints = gps2scr(points);
	
     var circle = new Path2D();		//綠色節點
	 var circle0 = new Path2D();	//紅色節點, 有語音者
	 var circle2 = new Path2D();	//所有節點中間填滿黑色
	 var path = new Path2D();
	 var circleTmp;
 	for ( p=0;p< mapPoints.length;p++){		//TODO 改用Path2D物件
		if(points[p][4-vector] == undefined){
			circleTmp = circle;
			// circle.moveTo(mapPoints[p][0], mapPoints[p][1]);
			// circle.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
		}else{
			circleTmp = circle0;
			// circle0.moveTo(mapPoints[p][0], mapPoints[p][1]);
			// circle0.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
		}
		circleTmp.moveTo(mapPoints[p][0], mapPoints[p][1]);
		circleTmp.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
			
		circle2.moveTo(mapPoints[p][0], mapPoints[p][1]);
		circle2.arc(mapPoints[p][0], mapPoints[p][1],5,0,Math.PI*2,true);
		path.lineTo(mapPoints[p][0], mapPoints[p][1]);
	}
	ctx.lineJoin="round";	//轉折點的樣式, miter(default), round扇形
	ctx.strokeStyle = "green";	//線條色
	ctx.lineWidth = 10;	//線條粗度
	ctx.stroke(path);
		  
	ctx.lineWidth = 3;	//線條粗度
	ctx.stroke(circle);
	  
	ctx.strokeStyle = "red";	//線條色
	ctx.stroke(circle0);
	  
	ctx.fillStyle = "black";
	ctx.fill(circle2);
	/*
	ctx.lineJoin="miter";	//轉折點的樣式, miter(default), round扇形 和 bevel三角形
ctx.miterLimit=5;		//最大斜接長度。斜接長度指的是在兩條線交匯處內角和外角之間的距離。

lineCap 線條端點的樣式, butt(default)方形, square 和 round圓形
setLineDash 方法和 lineDashOffset 屬性來制定虛線樣式
來源 https://kknews.cc/zh-tw/code/6azm5bl.html
	*/
}

function gps2scr(sourcePs){
	//經緯度座標「批次」轉螢幕座標
	//「假設」經緯度間隔等比例
	//但到時圖片貼上就偏了...
	var newPs=new Array();
	for(var i=0; i<sourcePs.length; i++){
		newPs[i] = new Array();
		newPs[i][0] =  (sourcePs[i][1] - centerCoords[1] )* zoom + centerX;
		newPs[i][1] = -(sourcePs[i][0] - centerCoords[0] )*zoom + centerY;
	}
	return newPs;
}

myCanvas.drawPoint=function (lat, lon, color, width){
	var drawX = (lon - centerCoords[1] )* zoom + centerX;
	var drawY = -(lat - centerCoords[0] )*zoom + centerY;
	//console.log(drawX + "," + drawY);
	ctx.strokeStyle = "red";	//線條色
	ctx.lineWidth = "1";	//線條粗度
	ctx.beginPath();
    ctx.arc(drawX, drawY,1,0,Math.PI*2,true);
	ctx.stroke();
}

function nearPoint(){
	// showMsg("nearPoint():"+recentPoint+";"+tasks[0][0]);
	//從路徑上找到最近的下一目標點, 但可能是適當點的前一點

	var shortstDist = getDistance(recentPoint,  tasks[0][0]);
	var bigAng = 0;
	var bigPoint=0;
	var bigTask = 0;
	for(var t=0; t < tasks.length; t++){
		// console.log(tasks[t][0][2]);
		for(var i=1; i < tasks[t].length; i++){
			dist = getDistance(recentPoint,  tasks[t][i]);
			 ang = angleOffset(recentPoint, tasks[t][i-1], tasks[t][i]);
			 if(ang > bigAng){
				 bigPoint = i;
				 bigTask = t;
				 bigAng = ang;
			 }
			if(dist < shortstDist){
				shortstDist = dist;
				nextPoint = i;
				taskID = t;
			}
		}
	}
	// showMsg("最近距離:" + tasks[taskID][nextPoint][2]);
	// showMsg("最大角度:" + tasks[bigTask][bigPoint][2]+"~"+tasks[bigTask][bigPoint-1][2]+", " + bigAng.toFixed(2));
	//TODO 最近點不在任何路徑範圍內
}

function geoYes (evt){
	// showMsg("geoYes()");
	
	recentPoint[0] = evt.coords.latitude;
	recentPoint[1] = evt.coords.longitude;
	strGPS = strGPS.substr(1,3)+strGPS.charAt(0);
	
	if(searchPoint){
		nearPoint();
		initTask();
		searchPoint = false;
		showMsg("1_nextPoint=" + nextPoint);
	}
	
	
	if(viewMode == 1){		//全圖：只畫點
		myCanvas.drawPoint(recentPoint[0], recentPoint[1]);
	}else{		//置中：全重畫, 不畫點
		centerCoords[0] = recentPoint[0];
		centerCoords[1] = recentPoint[1];
		myCanvas.drawClearMap();
		myCanvas.drawMiddleCross();
		myCanvas.drawBaseMap();
	}
	
	//showMsg(",23");
	nextDist = getDistance(recentPoint,  points[nextPoint]);
	
	// angle1 = Math.atan((recentPoint[0]- points[nextPoint][0])/(recentPoint[1] - points[nextPoint][1]));
	// shadowDist = Math.cos(angle1- pathAngle) * nextDist;
	//投影距離無法適用較大的轉角, 還是要用分角線y=ax+b
	//cos為距節點的投影距離, 用sin則為與路徑中線的距離



	_todo._250判定脫離路線 = function(){}	//AAAAAAAA
	_todo._220搜尋新路線 = function(){}	//AAAAAAAA
	_todo._230判定新方向 = function(){}	//AAAAAAAA
	//需要判定的項目
	//1.通過點, 才能繼續導航
	//2.提醒,及高速提醒
	//3.路線切換 ???
	//4.沒在路線上不可亂報
	fcolor = "";
	if (nextDist > preDist ){	//遠離中
		if(nextDist < evt.coords.speed/1000 * 2 + 0.015 ){
			//近距離內(車速的2秒),判定為通過
			if(points[nextPoint][4-vector]){
				playVoice("通過");
			}
			skipPoint();
			
			// pathAngle =  Math.atan((passPoint[0]- points[nextPoint][0])/(passPoint[1] - points[nextPoint][1]));
		}
		fcolor = "color='red'";
	}else{		//接近中
		
		if(enAlarmHigh && nextDist < 2 && evt.coords.speed*3.6 >70){
			//時速70以上, 2公里前提醒一次
			playVoice(points[nextPoint][4-vector]);
			enAlarmHigh = false;
		}
		/** 事前提醒*/
		//時速60公里 = 60x1000/60x60 = 60/3.6 = 16.6公尺/秒(步行4公里/小時)
		//車速每10公里提前2秒通知：
		//		120公里提前24秒, 33*24=792
		//		30公里時提前6秒通知,約8.1*6=48公尺。
		//		10公里,3秒,約4.1*3公尺,。
		//最後加12公尺給單車時,路中與路邊的距離補償用
		
		if(enAlarm ){
			minDist = evt.coords.speed/1000 * evt.coords.speed*3.6/10*2 + 0.015;
			if(nextDist < 0.05 || nextDist < minDist){
				playVoice(points[nextPoint][4-vector]);
				enAlarm = false;
			}
		}		
	}
	
	showData(evt);
	preDist = nextDist;
}

function _geoNo(evt){
	/*
		TODO 本函式塞到 watchPosition內。
		限https? win10本機檔用Chrome可開允許,但仍取得失敗。 手機note9待測
		Only secure origins are allowed 安全來源才可用geo...
		https://kknews.cc/zh-tw/tech/4qgkxq2.html
	*/
	if(evt.code == 1){
		showMsg("GPS未允用！");
	}else{
		showMsg(evt.code + ", " + evt.message);
	}
}

var watchID;
function startGPS(){
	//showMsg("startGPS()");
	if (!navigator.geolocation) {
		showMsg("GPS不支援。");
		return;
	}

		// navigator.geolocation.getCurrentPosition( geoYes, geoNo);
	navigator.permissions.query({name:'geolocation'}).then(function(result) {
		//權限判斷以乎對重覆檢查GPS是否啟用沒有關聯。
		if (result.state == 'denied') {	//denied禁用, prompt詢問, granted允許
			showMsg("GPS禁用！");
		}
		result.onchange = function() {
		}
	});
	/*
	var options = {
	  enableHighAccuracy: true,	//高精度, 實測更新間隔約1秒, 否則約20秒。
	  timeout: 5000,						//在note9用chrome會Timeout expired。
	  maximumAge: 0						//快取的過期時間，單位是毫秒，設為0來禁用快取讀取。
	};
	*/
	watchID = navigator.geolocation.watchPosition(geoYes, 
		//就算成功, 但中途失敗不會告知?
		(evt) =>{
				if(evt.code == 1){
					showMsg("GPS沒開！");	//User denied Geolocation
					//失敗後就不管了, 如何每秒檢查一次?
				}else{
					showMsg(evt.code + ", " + evt.message);
					//2, Network location provider at 'https://www.googleapis.com/' : ERR_NAME_NOT_RESOLVED
				}
		}, {enableHighAccuracy: true});
}

function stopGPS(){
	navigator.geolocation.clearWatch( watchID );
	showMsg("GPS停止定位。");
}

function getDistance(coord1, coord2) {
	//兩座標間的距離, 傳回：單位公里, 小數點後三位
    //本函式來源 https://www.geodatasource.com/developers/javascript
	lat1	= coord1[0].toFixed(5);	//用小數5位算距離
	lon1= coord1[1].toFixed(5);
	lat2	= coord2[0].toFixed(5);
	lon2= coord2[1].toFixed(5);
	
    var radlat1 = Math.PI * lat1/180;
    var radlat2 = Math.PI * lat2/180;
    var theta = lon1-lon2;
    var radtheta = Math.PI * theta/180;
    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    if (dist > 1) {
        dist = 1;
    }
    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;	//不明常數
    dist = dist * 1.609344 ;		//英浬轉公里

    return dist.toFixed(3);		//小數點後三位(四捨「六入」)
}
	var fcolor = "";
	var strGPS = "\|/-";	//
function showData(evt){
	console.log("showData(s)");
	try{
		str="";
		// str = nextPoint+ "_"
		str += strGPS.charAt(0);
		str += points[nextPoint][2] + ", ";
		str += (nextDist < 1) ? ("<font "+ fcolor+">" + nextDist*1000+"</font>公尺") : (Math.round(nextDist)+"公里");
		
		if(evt){
			arriveSec =  nextDist*1000/evt.coords.speed;
			if(arriveSec < 99){
				str += "(" + arriveSec.toFixed(0)+"秒)";
			}
			str += "<br/>時速："+ (evt.coords.speed*3.6).toFixed(1) + "公里。";	//原單位：米/秒
			str += "方向：" + Math.round(evt.coords.heading);	//方向為正北的順時針0~360
		}
		
		if(vector ==1){	//去程
			tmp0 = 0;
			tmp1 = points.length-1;
		}else{
			tmp0 = points.length-1;
			tmp1 = 0;
		}
		str += "<br>任務：" + points[tmp0][2] + " ~ " +points[tmp1][2];
		dA = angleOffset(recentPoint,passPoint,points[nextPoint]);
		str += "<br>夾角：" + dA.toFixed(2);
		str += "("+(dA*360/2/Math.PI).toFixed()+")";
	} catch(e){
		str += e.message;
	}finally {
		document.getElementById("posStr").innerHTML=str;
	}
	

		//str += "<br />距離：<br />時速：";

		// if(nextDist >1){
			
		// }else{
			// str += "，" + (nextDist*1000).toFixed() + "公尺，";
			// }
/*
	if(evt == undefined){
			str+= evt;
	}else{
		str += "，" + nextDist.toFixed(1)  + "公里，";
		
		arriveSec =  nextDist*1000/evt.coords.speed;
		if(arriveSec < 99){
			str += arriveSec.toFixed(0)+"秒。";
		}
		//alert(str);
		//str += "<br />位置：" + recentPoint[0] + ", "+ recentPoint[1];
		str += "<br/>時速："+ (evt.coords.speed*3.6).toFixed(1) + "公里。";	//原單位：米/秒
		str += "方向：" + Math.round(evt.coords.heading);	//方向為正北的順時針

	}
			if(vector ==1){
			tmp0 = 0;
			tmp1 = points.length-1;
		}else{
			tmp0 = points.length-1;
			tmp1 = 0;
		}
		str += "<br>" + points[tmp0][2] + " ~ " +points[tmp1][2];
	//	str += "("+ points[nextPoint][0] +", " + points[nextPoint][1];
		document.getElementById("posStr").innerHTML=str;
*/
console.log("showData(e)");
}

var msgList = ["","","","",""];
var msgID = 0;

function  showMsg(str){
	msgList[msgID] = str;
	output = msgList[msgID] + "<br/>";

	for(i=msgID+1; i < msgList.length; i++){
		output += msgList[i] + "。";
	}
	for(i=0; i < msgID; i++){
		output += msgList[i] + "。";
	}
	// console.log(output);
	document.getElementById("watchStr").innerHTML= output;
	
	msgID --;	//新的訊息放前面
	if(msgID < 0){
		msgID = msgList.length - 1;
	}
}

function newCache(){
			cache.delete('.');
		cache.delete('index.html');
	//將"gps"快取中的key全部刪除
	/*
	caches.open('gps')
		.then(function(cache) {
			cache.keys()
			.then(function(keys) {
				keys.forEach(function(request, index, array) {
					cache.delete(request);
				});
			});
		});
	*/	
}

function displayNotification(){
    if('serviceWorker' in navigator){
        var options = {
            body: '歡迎進入30天PWA的世界'           
        };
        navigator.serviceWorker.ready
            .then(function(sw){
                sw.showNotification('訂閱成功！！！', options);
            })
    }  else{
		
	}
     
}

var IntervalID;
var countRun = false;
var isMarch = -1;
var march = document.getElementById("march");
var timeNum = [40,,60];	//TODO 連續號誌使用同一時序。轉向時兩個值互換。
var colorList = ["red",,"green"];
/**紅綠燈讀秒, 時間到或用戶點選時會變色及重數 */

function swColor(){
	_todo._810紅綠燈記錄 = function(){}	
	//初始綠色靜止秒數零, 按一下開始增加, 
	//按一下(記錄綠色秒數G3)變紅且從零增加,
	//再按一下(記錄G3R40)變綠且從零增加
	//跳點後,存檔G3R40G24,畫面回復初始狀態
	_todo._820紅綠燈讀秒 = function(){}	
	//看到燈號時按一下, 再按一下變更顏色,倒數, 下一點時間不同則要回復初始狀態
	if(!countRun){
		//停止狀態則啟動
		IntervalID = window.setInterval(( () =>  {
			//休眠狀態將回調函數放在隊列中,等瀏覽器再次打開的時候，一瞬間全部執行
			if(count < 0){
				isMarch *= -1;
				count = timeNum[1+isMarch];
				march.style.color = colorList[1+isMarch];
			}
			march.innerText = count--;
		}	) , 1000);
		count = timeNum[1+isMarch];
		countRun=true;
	}else{
		isMarch *= -1;
		count = timeNum[1+isMarch];
		march.style.color = colorList[1+isMarch];
		march.innerText = count--;
	}
}

function exportCoord(){
//座標清單匯出檔案,再用Http_file_server傳到電腦
  var fileName = "a.csv";//匯出的檔名
  var data = ins.innerHTML;	//TODO 要把BR改成\n\r
  var blob = new Blob([data], {
    type : "application/octet-stream"
  });
  //實作一個標簽, 好像不正規。
  var href = URL.createObjectURL(blob);
  var link = document.createElement("a");
  document.body.appendChild(link);
  link.href = href;
  link.download = fileName;
  link.click();
}

//document.getElementById('input').click();
// document.getElementById("fileInput").onchange = () => {
  // const selectedFiles = [...fileInput.files];
  // console.log(selectedFiles);
// }

/**
	程式功能：手機/GPS, 於特定路線上目標點提示路況(提早放油門, 減少煞車)
	目標1：山路有坑洞與急彎要提前通知
		資料源：除用gmap取得座標,內建路徑, 移動中要即時記錄,儲存(小數後七位不夠)
			儲存：csv匯入indexDB, 插入, 匯出
				設定：5個按鈕直接顯示在畫面上, 開車者要去按。
					暫時方案：存到本地變數
		語音：先上網下載並cache。之後可自行錄音, 存到cache
				
		
	目標2：平面道路紅綠燈讀秒(先手動)
	目標3：提醒下交流道???
	
	必要條件：GPS沒開要持續watch, 中途沒GPS要提示, 卡住了
	
	錯誤處理：
		手機上的文字大小會變動???
*/
</script>
</html>