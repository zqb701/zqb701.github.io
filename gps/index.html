<!doctype html>
<html lang=zh_tw.UTF-8 manifest="index.manifest">
<head>
	<meta charset="utf-8">
	<!-- 程式來源 https://blog.xuite.net/gkyo0510/wretch/242769650 -->
	<title>GPS02-2</title>

</head>

<style>  
	.cmdButton {
		width:200px;
		height:200px;
		border-width:3px;
		border-style:dashed;
		border-color:#FFAC55;
		padding:5px;
		
		text-align:center;	//水平置中
		top:0px;
		line-height:200px;//文字垂直置中(行高等於容器高度),單行適用
	}  
</style>  

<body onload="init();" bgcolor="black" text="gray" topmargin="0" leftmargin="0">
	<f function HTML_body(){}/>
	版本：012
	<br>
	<canvas id="canvas"></canvas>
	<font size="7">
	<div style="display: flex; justify-content: flex-end;">
		<div class="cmdButton" onclick="insertCoord('坑洞');" ontouchend="this.click;">坑洞</div>
		<div class="cmdButton" onclick="insertCoord('急彎');">急彎</div>  
		<div class="cmdButton" onclick="insertCoord('號誌');">號誌</div>
		<div class="cmdButton" onclick="newTask();">新任務</div>
		<div class="cmdButton">
		<div id="march" style="color:red; font-size:120px;font-weight:bolder;" onclick="swColor();">99</div></div>
	</div>
	
	
	<p id="posStr">111222</p>
	</font>
	<font size="6">
	<p id="watchStr">監控狀態</p>
	</font>
	<input type="button" value="GPS啟動" onClick="startGPS();">
	<input type="button" value="GPS停止" onClick="stopGPS();">
	<input type="button" value="更新快取" onClick="newCache();">
	<input type="button" value="通知測試" onClick="displayNotification();">
	<input type="button" value="清除軌跡數據" onClick="ins.innerHTML='';localStorage.insertCoord='';">
	
	<input type="button" value="匯出" onClick="exportCoord();">
	<input type="file" multiple id="input" style___='display:none;'>
	
	<p id="insertCoord"></p>
</body>
<script defer>
	//defer:資源載入後才執行, async同, 但不保證照順序, 空白則立即執行,
	//等同 window.addEventListener('load', function() {...}
    if ('serviceWorker' in navigator) {
		navigator.serviceWorker.register('sw.js')	//參數scope設定掌管範圍, 預設為???
		.then(reg => console.log('完成 SW 設定!', reg))
            .catch(err => console.log('Error!', err));
		//sw.js須為獨立檔案, 無法把程式全部塞在一個檔案。
		
		navigator.serviceWorker.addEventListener("message", function(event) {
			showMsg(event.data);
		});
    }
</script>
<script>
//TODO 到指定網站下載gps檔(並cache)
function var_tasks(){ }//本行給notepad++的函式清單用(大引號不可靠在一起)
var tasks = [[
		[22.667523721107013, 120.4978306934891, "民生廣東路口","號誌"],
		[22.6660872645837,		120.50037043288955,	"工業路口","號誌",,"號誌"],
		[22.665707901738443,	120.5010424041541,	"69巷","號誌"],
		[22.66528466599206,		120.5017954343364,	"殺蛇溪", "號誌",,"號誌"],
		
		[22.665066241181687, 120.50217027304704, "民福路","號誌",,"號誌"],
		[22.6642219442753, 120.50369274070279, "民生校區",,, "號誌"],
		[22.66339089234732, 120.50520474477672, "菸廠路", "號誌"],
		
		[22.66279229323675, 120.50623662222313, "瑞民路口",,,"號誌"],
		[22.662224974588675, 120.50727148282286, "歸仁路口", "號誌",,"號誌"],
		[22.660783934931143, 120.50977659008726, "瑞屏街口",,, "號誌"],
		
		[22.65990848834937, 120.51121889337335, "和生路口","號誌",,"號誌"],
		[22.659470893607228, 120.51209569251994, "安心四橫巷", "路口",,"路口"],
		[22.65982669905339, 120.51235318458225, "田中巷口", "路口",,"路口"],
		
		[22.65956412062677, 120.5130726983204, "二橫巷","測速",,"測速"],
		[22.659505837597436, 120.5143833817605, "10號", "休息站"],
		[22.659390282100908, 120.51514639840148, "瑞光路口", "路口",,"路口"],
		
		[22.658030217493362, 120.514628916623, "國仁路口", "號誌",, "號誌"],
		[22.655579780727386, 120.51407578585876, "彎道"],
		[22.652150360224123, 120.51053770124854, "歸禮巷","路口",,"路口"],
		[22.651995666533377, 120.5111949090511, "彎01"],
		[22.651445528597453, 120.51110103173282, "彎02"],
		[22.65037439483884, 120.51412461031919, "歸義段", "休息站"]
	],[
		[22.658034247616996, 120.5146302173418,"國仁路口"],
		[22.659914735641667, 120.51117374021372,"屏商路口"],
		[22.65983459647982, 120.50578459146016,"歸仁彎"],
		[22.652905040831186, 120.49474121968251, "和生彎"],
		[22.651762313125314, 120.48597167701199, "復興路口"],
		[22.655823532381984, 120.46656980548235, "建國路口"],
		[22.642159446314253, 120.4185087722723, "磚仔窰"],
		[22.633618032191855, 120.38857434750723, "賓士路口"],
		[22.63635369740717, 120.38229941534014,"彎道1"],
		[22.635421093866388, 120.37318949926723, "彎道2"],
		[22.63413212059094, 120.37012392539445, "彎道3"],
		[22.63634876160687, 120.35721342010389, "文衡路"],
		[22.634581156634074, 120.35822752986832, "文衡彎道"],
		[22.63337989604311, 120.3579774601367, "文化路"],
		[22.633949053558847, 120.35468108635685, "大潤發"]	
	],[
		[22.659389112309576, 120.51514843327135,"田中巷口","號誌"],
		[22.66042539472848, 120.5153220745,"單車道", "號誌",,"號誌"],
		[22.661457518466925, 120.51546704670002, "瑞光彎道1"],
		[22.665190350620573, 120.51312797662538,"香揚巷口", "號誌",,"號誌"],
		[22.669040797908576, 120.51069667037709, "瑞光彎道2"],
		[22.673650031059577, 120.51056656006223, "田寮巷口", "號誌",,"號誌"],
		[22.675343791402256, 120.51041230398191, "瑞光彎道3"],
		[22.676452289680334, 120.50955647049913, "建豐路口", "號誌",,"號誌"],
		[22.680967230062606, 120.5055987046144, "瑞光彎道4"],
		[22.68296750430608, 120.50505775656028, "大連路口", "號誌",,"號誌"],
		[22.687119793082346, 120.50397282994732, "華正路口", "號誌",,"號誌"],
		[22.692732317780546, 120.50245954225517,"海豐街", "號誌",,"號誌"],
		
		[22.695511971450234, 120.5054161117716,	 "盛豐路", "號誌",,"號誌"],
		[22.696883960767217, 120.50906180826027,"18巷", "號誌",,"號誌"],
		[22.698434438925595, 120.5144862524928,	 "XX巷", "號誌",,"號誌"],
		[22.701152592239588, 120.51891439357674, "彎道"],
		[22.702703598302563, 120.51973392246246, "屏34", "號誌",,"號誌"],
		[22.705400301590082, 120.52084164949027, "屏XX", "號誌",,"號誌"],
		[22.70880261417915,	 120.52199195978083, "德和路", "號誌",,"號誌"],
		[22.7151486520024,	 120.52903378461157, "海豐交流道", "號誌",,"號誌"],
		
		[22.749973605486066, 120.49659819389186,"九如交流道北上"],
		[22.755737015999156, 120.4862825614745,"九如交流道南下"],
		[22.77964242423787, 120.427908073193665,"燕巢系統北上"],
		[22.794471334710444, 120.42609095864529,"燕巢系統南下"],	//接國10匣道加長
		[22.972969515201683, 120.33025066426973,"關廟系統北上","交流道"],
		[23.026761370636468, 120.32717946883794,"新化休息站北上"],
		[23.055614880035566, 120.3213650686524,"新化系統北上"],
		[23.160111264166215, 120.34888474924794,"官田系統北上"],
		[23.259032533296, 120.3761323379591,"柳營交流道北上","交流道"],
		[23.271338325253637, 120.3783841435445, "柳營交流道北上",,,"路口"],
		
		[23.270214334942427, 120.37907987648953,"閘道","急彎"],
		[23.26791494025789, 120.38048922441678,"165路口","路口",,"路口"],
		[23.27072646483229, 120.38336295538674, "旭山路口","號誌",,"號誌"],
		[23.283454163556105, 120.3834169629939, "義士路口","號誌",,"號誌"],
		[23.29493901838239, 120.38556569359515, "東河路口","號誌",,"號誌"],
		[23.307793557109218, 120.39991497924557, "北馬彎1","急彎"],
		[23.30941176650411, 120.39979334024561, , "北馬彎2",,,"急彎"],
		[23.31062426006925, 120.40028523189007, "測速",,,"測速"],
		[23.318507349252233, 120.40299714640597, "公園路口","號誌",,"號誌"],
		[23.321184332623805, 120.40322488355994, "民有街口","路口"],
		[23.32108328032145, 120.40447735836689, "民有街","休息站"]
		
	],[

		[22.66870485598517, 120.48572274512632,"南二門","廁所"],
		[22.668258854960587, 120.48931283122437,"復興路口","號誌"],
		[22.666716941498812, 120.48890159338008, "自由復興路口","號誌"],
		[22.66616756924055, 120.4913256311424,"自由路彎道"],
		[22.669222036792192, 120.49452819798431, "民生自由路口","號誌"],
		[22.667523721107013, 120.4978306934891, "民生廣東路口","號誌"],
		[22.6660872645837,		120.50037043288955,	"工業路口","號誌",,"號誌"],
		[22.662224974588675, 120.50727148282286, "歸仁路口", "號誌",,"號誌"],
		[22.65990848834937, 120.51121889337335, "和生路口","號誌",,"號誌"],
		
		[22.658034247616996, 120.5146302173418,"瑞光路口", "號誌",, "號誌"],
		[22.655539129939942, 120.51901611238941, "果菜市場","號誌",,"號誌"],
		[22.65164196538594, 120.52577244459546,"測速照相",,,"測速"],
		[22.650677214478804, 120.52685860645906, "民族路口","號誌"],
		[22.649322449799737, 120.52806492385191, "大同街口", "號誌",,"號誌"],
		[22.64284588050273, 120.5338488670412, "長安巷", "號誌",,"號誌"],
		[22.6400899784641, 120.53628286483544, "麟洛國中路口", "路口",, "路口"],
		
		[22.64386407794312, 120.5407651735537, "麟洛交流道", "號誌"],
		[22.646887968356193, 120.54422751976801, "彎道"],
		[22.650260226458116, 120.54568906280016, "民生路口", "號誌",,"號誌"],
		[22.655381953796578, 120.55160925823591, "科大路口", "路口",,"路口"],
		[22.653958635505553, 120.56099718185452, "南豐路口","號誌",,"號誌"],
		[22.652601671108002, 120.56930340677384, "科大彎道"],
		[22.650020204517485, 120.57232527227198, "新生路口","號誌"],
		[22.64920952763707, 120.57317083867531,"新生路口",,,"號誌"],
		[22.644074768025085, 120.57842934867084, "測速照相",,,"測速"],
		[22.643333748129898, 120.57925428694658, "大同路口","號誌",,"號誌"],
		[22.634758245038586, 120.58804450981617, "科大北路","號誌",,"號誌"],
		[22.630047211459626, 120.59291416762996, "老埤路口", "路口",,"路口"],
		[22.633128880246172, 120.59797113670795, "安通路口", "路口",,"路口"],

		[22.62871783050417, 120.62638157350078,"沿山路口", "路口",,"路口"],
		[22.62210667218307, 120.62556054399592, "保安路口", "號誌",,"號誌"],
		[22.61246586071109, 120.6200526260988, "彎道"],
		[22.604416359284045, 120.62024646947125, "營區路口","號誌",,"號誌"],
		[22.59858233469853, 120.62046577629641, "測速照相","測速"],
		[22.591721713708438, 120.62115374455101, "佳平路口", "路口",,"路口"],
		
		[22.590483410935843, 120.62465695816196,"水泉山公園","急彎",,"急彎"],
		[22.592155787378577, 120.63335669509607,"消防隊","急彎",,"急彎"],
		[22.5876388,120.6347535,"水溝蓋01","坑洞",,"坑洞"],// 02/21 
		[22.5874109,120.6384348,"水溝蓋02","坑洞",,"坑洞"],// 02/21 
		[22.58972948061996, 120.63908090610973, "112基地"],
		[22.59007659798934, 120.64766077466638,"橋","急彎",,"急彎"],
		[22.582703739665064, 120.64590316103639, "急彎01","急彎",,"急彎"],
		
		[22.58156375746854, 120.64774690725149,"急彎A","急彎",,"急彎"],
		[22.58345391607421, 120.64720794662499,"急彎B","急彎",,"急彎"],
		[22.580992567577628, 120.64849052598437,"急彎C","急彎",,"急彎"],
		[22.58305093602287, 120.64777911612705,"急彎D","急彎",,"急彎"],
		[22.57838760565134, 120.64971247385891,"坑洞03","坑洞",,"坑洞"],
		[22.571896220921186, 120.65036759528631,"逍遙山莊","急彎",,"急彎"],
		
		[22.578508767064537, 120.65131389357563,"坑洞04","坑洞",,"坑洞"],
		[22.587039118932154, 120.65992939675222,"急彎I","急彎",,"急彎"],
		[22.590629698135977, 120.65974713603376,"急彎J","急彎",,"急彎"],
		[22.590471544673793, 120.66264498498556,"急彎K","急彎",,"急彎"],
		[22.58924109879525, 120.66460999148127, "大武山之門","路口",,"路口"],
		[22.593386038796442, 120.67046156816451, "返璞","坑洞",,"坑洞"],
			[22.59176168536461, 120.67935691835952,"貨櫃屋","坑洞"],
		[22.591599051656083, 120.68486212232875, "坑洞05","坑洞",,"坑洞"],
		[22.592177531280022, 120.68483357628378, "坑洞06","坑洞",,"坑洞"],
		[22.595115994968776, 120.68506473873026, "觀自在"],
		[22.606633881440352, 120.69482779987918, "空地","急彎",,"急彎"],
		[22.6145008,120.7017865,"泰武停車場","休息站",,"休息站"],
		[22.615443681182708, 120.70262923538111, "坑洞","坑洞"]
	],[	//台86,關廟系統
		[22.97668452704216, 120.32249768738073, "關廟彎道", "靠右"],
		[22.975157067181804, 120.31877334375743, "台19甲","號誌",,"號誌"],
		[22.971278480819183, 120.31327247513406, "測速","測速"],
		[22.94149314730315, 120.30124755313828, "彎道01"],
		[22.934595270792208, 120.26099575774114, "彎道上崙交流道"],
		[22.942623194631146, 120.24965817528305, "彎道仁德系統"],
		[22.932049664423836, 120.22499353058586, "台一交流道東", "交流道"],
		[22.9314528036442, 120.22194023530919, "閘道"],
		[22.937275501642834, 120.22099726418344, "文華路口", "號誌",,"號誌"],
		[22.941787731378756, 120.22095711150357, "彎道02"],
		[22.93992471408244, 120.2210067902625, "測速",,,"測速"],
		[22.94405536181032, 120.22033245507691, "文賢路口","號誌",,"號誌"],
		[22.952419382785543, 120.21798832077249, "亞航街前", "號誌"],
		[22.960437309262627, 120.21697996600106, "保仁路"],
		[22.964595069946935, 120.21645445767052, "生產路","號誌",,"號誌"],
		[22.972416153855065, 120.21481356468252, "中華路","號誌",,"號誌"],
		[22.97629414889348, 120.21394046244464, "大林路", "號誌",,"號誌"],
		[22.9807394351853, 120.2123072481083, "大同路100巷", "路口"]
	]];

	var taskID = 2;
	var points = [];
	//var mapPoints = [];
	var taskTitle = "";
	var zoom = -1;
	
	var nextPoint = 0;	//下一個點
	var Point01 = [22.659517486714293,120.51431010230766, "田中巷"];	
	var Point02 = [22.66613321392555, 120.50085349955407,"一樓"];
	var recentPoint = Point02;
	//上一個通過的點
	var passPoint = [0,0];
		passPoint[0] = recentPoint[0];
		passPoint[1] = recentPoint[1];
		
	var zoom0 = -1;
	var zoom1 = -1;
	
	var centerCoords0 = [23,120.5];
	var centerCoords = [23,120.5];
	
	var nextDist = -1;
	var shadowDist = -1;
	var preDist = 0;
	var incDistCnt = 0;
// var heading = -1;	//目標的方向0~360(以前一目標計算,但初值以移動點計算)
	var pathAngle = -1;
	// 尋標,新任務或去回程切換時要開啟, 有GPS的狀態時依據當前座標找到最近點
	var searchPoint=true;
	
	var receGap = 0;
	var prevGap = 0;
	//任務的去回行程, 回程為-1
	var vector = 1;	
	/** 一般提醒*/
	var enAlarm = true;
	/** 高速提醒*/
	var enAlarmHigh = true;
	
	var canvas = document.getElementById("canvas");
	//canvas.addEventListener("click", click, false);

    canvas.addEventListener('mousedown',mouseDown);
	canvas.addEventListener('mousemove',mouseMove);
	canvas.addEventListener('mouseup',mouseUp);
	
	canvas.addEventListener('touchstart',touchStart);
    canvas.addEventListener('touchmove',touchMove);
    canvas.addEventListener('touchend',touchEnd);

	var enGestures = false;
	
	var ctx = canvas.getContext("2d");

	canvas.width = 950;canvas.height = 950;		//寬高預設值為300×150
	// canvas.width = window.innerWidth;
	// canvas.height = canvas.width;
	var centerX = canvas.width  / 2;
	var centerY = canvas.height / 2;
	

	//var scrPoint = gps2scr(recentPoint);
	const voice = new Audio();
	//voice.volume = 0.5;//預設值為何?

	 var startGestX = -1;
	var startGestY = -1;

	var oldClickTimes = -1;
	var viewMode = 1;
	
	var ins = document.getElementById("insertCoord");

	class TODO {}// function TODO(){}
	var _todo = new TODO();
	_todo._110函式用物件分組 = function(){}
	
function init(){
		//file://即使同意, 仍然禁止
	/*
	if ('Notification' in window) {
		Notification.requestPermission(function(status){
			console.log('User Choice', status);
			if (status !== 'granted') {
				console.log('推播允許被拒絕了!');
			} else {

			}
		});
	new Notification('訂閱成功！！！');
	}
	*/
	startGPS();
	
	newTask();
	newSpace();

	// startGPS();
	noSleep();	//note 9 上, chrome有效, 三星無效

	drawClearMap();
	drawBaseMap();
		nextDist = getDistance(recentPoint,  points[nextPoint]);
		newDist2 = Math.cos(2*Math.PI *150/360 - Math.atan((recentPoint[1]- points[nextPoint][1])/(recentPoint[0] - points[nextPoint][0])))*nextDist;
	//console.log(nextDist + ", " + newDist2);
	showData();

}

function insertCoord(coordType){
	//	新增點, 插入陣列內, 陣列滙出, 5種新增鈕
	//console.log("insertCoord()");
		//document.getElementById("watchStr").innerHTML= output;
	
	strtmp =   
		points[nextPoint][2]+":"+
		recentPoint[0]+","+recentPoint[1] + ",自訂點,"+
		coordType +		"<br/>" ;
		
		if (typeof (Storage) != "undefined"){
        if (localStorage.insertCoord != "undefined"){
            //msg.innerText = localStorage.playVolume;
			localStorage.insertCoord = strtmp + localStorage.insertCoord;
            ins.innerHTML = localStorage.insertCoord;
        }
	}
	//showMsg(recentPoint[0].toFixed(7)+","+recentPoint[1].toFixed(7));
}

function newSpace(){	
/**計算適當的繪圖位置
	找出所有點分佈範圍的邊界值, 算中心點及比例
*/
 /*
 for(p in points){
	points[p][0] = Math.round(points[p][0], 5);
	points[p][1] = Math.round(points[p][1], 5);
 }
 */
 	//找出四邊的點以算出放大值zoom
var maxN = points[0][0];
var maxS = points[0][0];
var maxE = points[0][1];
var maxW = points[0][1];

for(p in points){
	if(points[p][0] > maxN) maxN = points[p][0];
	if(points[p][0] < maxS) maxS = points[p][0];
	if(points[p][1] > maxE) maxE = points[p][1];
	if(points[p][1] < maxW) maxW = points[p][1];
}

	if((maxN - maxS) >(maxE - maxW)){	//比較長與寛,較大者的拿來算比例
		zoom = canvas.height * 0.9/(maxN - maxS);
	}else{
		zoom = canvas.width * 0.9/(maxE - maxW);
	}
	zoom0 = zoom;
	centerCoords0[0] = (maxN + maxS)/2;
	centerCoords0[1] = (maxE + maxW)/2;

	centerCoords[0] = centerCoords0[0];
	centerCoords[1] = centerCoords0[1];
}

function touchStart(e){
	gesturesStart(e.targetTouches[0].pageX,e.targetTouches[0].pageY);
	e.preventDefault();//避免觸發 click()
}

function mouseDown(e){
	gesturesStart(e.pageX, e.pageY);
	e.preventDefault();
}

function gesturesStart(x,y){
//	showMsg("gesturesStart()");
		//手勢起始位置在九宮格中央才會運作
		var recentTime = new Date().getTime();
		
		if(x > canvas.width/3 && x <canvas.width*2/3 && y > canvas.height/3 && y < canvas.height*2/3){
				//上一行以乎可以用inner區塊的方法
			if(recentTime - oldClickTimes < 300){		//double click的間隔
				//縮放模式
				enGestures = true;
//				console.log("enGestures=" + enGestures);
				zoom1 = zoom;
				//ctx.beginPath();
				//ctx.moveTo(x, y);
				startGestX = x;
				startGestY = y;
			}else{
				//移動模式
			
			}
		}
		//移動
}

	var endGestX = -1; 
	var endGestY = -1;
function gesturesMove(x, y){
//	showMsg("gesturesMove()");
	endGestX = x;
	endGestY = y;
	if(enGestures && zoom>= zoom0/3){		//縮小不能小於1/3。那放大呢???
		 drawClearMap();
		 zoom =zoom1 *(1+(y-startGestY)*0.01);
		 if(zoom < zoom0/3)zoom = zoom0/3;
		 drawBaseMap();
	 }
}

function touchMove(e){
	gesturesMove(e.targetTouches[0].pageX,e.targetTouches[0].pageY);
	e.preventDefault();
}

function mouseMove(e){
	gesturesMove(e.pageX,e.pageY);
	e.preventDefault();
}

function gesturesEnd(){
	if(enGestures){
		enGestures = false;
	}else{
		gridCmd(endGestX, endGestY);
	}
}

function touchEnd(e){
	gesturesEnd();
	e.preventDefault();
}

function mouseUp(e){
	gesturesEnd();
	e.preventDefault();
}

async function noSleep(){	
//不自動休眠, Note9 chrome 92.0.4515.131有效, 但三星browser 16.0.6.23無作用。
	// The wake lock sentinel.
	let wakeLock = null;
	// Function that attempts to request a screen wake lock.
	const requestWakeLock = async () => {
		try {
			wakeLock = await navigator.wakeLock.request('screen');
			wakeLock.addEventListener('release', () => {
				//console.log('Screen Wake Lock was released');
			});
		//console.log('Screen Wake Lock is active');
		//alert("NoSleep");
		} catch (err) {
			console.error(`${err.name}, ${err.message}`);
		}
	};
	// Request a screen wake lock…
	await requestWakeLock();
}


function click(e){	//觸發座標為滑鼠放開處
	e.preventDefault();
	document.getElementById("watchStr").innerHTML="click()";
	//var x = event.pageX;
	//var y = event.pageY;
	gridCmd(e.pageX, e.pageY);
}

function gridCmd(x,y){
//showMsg("gridCmd(), x=" + x +", y=" +y);
		var gridW = canvas.width/3;
		var gridH = canvas.height/3;
		oldClickTimes = new Date().getTime();
		
		if(x > gridW*2 && x < canvas.width-50 && y > gridH*2){	//右下角
		//&& x < canvas.width-50 用來避免note 9 的圓邊誤觸
			newTask();		
			return;
		}

		if(x > gridW*2 && x < canvas.width-50 && y < gridH){//右上角
			//&& x < canvas.width-50 用來避免note 9 的圓邊誤觸
			skipPoint();	//手動跳一點, 差太多點則切換方向重找最近點
				//
			// searchPoint = true;
			return;
		}
		
		if(x < gridW && x > 50 && y < gridH){//左上角
			//console.log("左上角_去回切換");
			vectorMode();
			return;
		}
		
		if(x < gridW && x > 50 && y > gridH*2){	//左下角
			//console.log("左下角_測試音效");
			viewSW();
			return;
		}
	}
	
function vectorMode(){
	if(vector ==1){
		vector = -1;//回程
		nextPoint = points.length-1;
		playVoice("回程");
	}else{
		vector = 1;//去程
		nextPoint = 0;
		playVoice("去程");
	}
	searchPoint =true;
	showData();
}

function viewSW(){
	viewMode *= -1;		//兩種模式切換
	if(viewMode == 1){
		playVoice("全圖");
		centerCoords[0] = centerCoords0[0];
		centerCoords[1] = centerCoords0[1];
		zoom = zoom0;
	}else{		
		playVoice("置中");
		centerCoords[0] = recentPoint[0];
		centerCoords[1] = recentPoint[1];
	}
	drawClearMap();
	drawBaseMap();	
}

function playVoice(str){
	//語音來源：22/1/30雅婷文字轉語音下載wav檔, https://tts.yating.tw/
	//其它：google翻譯,可透過SoundOfText網站下載, 或自己用DevTools下載mp3
	if(str == undefined) return ;
	
	var fileName = "../voice/"+ str+".wav";
		voice.src = fileName;
		_todo._710找不到語音檔要報錯_並播放其它 = function(){}	//AAAAAAAA
		try {
			voice.load();
			voice.play();
		}catch (e) {	//完全抓不到error
			showMsg(e);
		}
}

function newTask(){
	//任務切換
	nextPoint = 0;
	nextDist = -1;
	preDist = 0;
	incDistCnt = 0
	vector = 1;
	viewMode = 1;
	searchPoint = true;
	
	taskID ++;
	if (taskID == tasks.length) taskID = 0;
	points = tasks[taskID];
	
	newSpace();
	drawClearMap();
	drawBaseMap();
	
	playVoice("新任務");
	showData();
	_todo._220路徑併接模式 = function(){}
}	

function skipPoint(){
	enAlarm = true;
	enAlarmHigh = true;
	nextPoint += vector;
	
	if((nextPoint < 0 ) || (nextPoint == points.length)){
		//playVoice("端點");
		showMsg("端點");
		return;
	}else{
		if(points[nextPoint-vector][4-vector]){
			playVoice("通過");
		}
		passPoint[0] = points[nextPoint-vector][0];
		passPoint[1] = points[nextPoint-vector][1];
	}
	showData();	 
}	

function drawClearMap(){
	ctx.fillStyle = "black";	//填滿色
	ctx.fillRect(0,0,canvas.width,canvas.height);
	ctx.strokeStyle = "blue";	//線條色
	ctx.lineWidth = 2;	//線條粗度
	ctx.strokeRect(0,0,canvas.width,canvas.height);
	ctx.strokeRect(canvas.width/3,canvas.height/3,canvas.width/3,canvas.height/3);
}

function drawMiddleCross(){
				//在畫面中央畫十字
		ctx.strokeStyle = "white";	//線條色
		ctx.lineWidth = "2";	//線條粗度
		ctx.beginPath();
		ctx.moveTo(centerX-20, centerY);
		ctx.lineTo(centerX+20, centerY);
		ctx.moveTo(centerX, centerY-20);
		ctx.lineTo(centerX, centerY+20);
		// start = Math.PI*(evt.coords.heading/180 - 0.5);
		// ctx.arc( centerX, centerY,10,start,start-Math.PI*2,true);
		ctx.stroke();
	
}

function drawBaseMap(){
	 var mapPoints = gps2scr(points);
	
     var circle = new Path2D();		//綠色節點
	 var circle0 = new Path2D();	//紅色節點, 有語音者
	 var circle2 = new Path2D();	//所有節點中間填滿黑色
	 var path = new Path2D();
	 var circleTmp;
 	for ( p=0;p< mapPoints.length;p++){		//TODO 改用Path2D物件
		if(points[p][4-vector] == undefined){
			circleTmp = circle;
			// circle.moveTo(mapPoints[p][0], mapPoints[p][1]);
			// circle.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
		}else{
			circleTmp = circle0;
			// circle0.moveTo(mapPoints[p][0], mapPoints[p][1]);
			// circle0.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
		}
		circleTmp.moveTo(mapPoints[p][0], mapPoints[p][1]);
		circleTmp.arc(mapPoints[p][0], mapPoints[p][1],7,0,Math.PI*2,true);
			
		circle2.moveTo(mapPoints[p][0], mapPoints[p][1]);
		circle2.arc(mapPoints[p][0], mapPoints[p][1],5,0,Math.PI*2,true);
		path.lineTo(mapPoints[p][0], mapPoints[p][1]);
	}
	ctx.lineJoin="round";	//轉折點的樣式, miter(default), round扇形
	ctx.strokeStyle = "green";	//線條色
	ctx.lineWidth = 10;	//線條粗度
	ctx.stroke(path);
		  
	ctx.lineWidth = 3;	//線條粗度
	ctx.stroke(circle);
	  
	ctx.strokeStyle = "red";	//線條色
	ctx.stroke(circle0);
	  
	ctx.fillStyle = "black";
	ctx.fill(circle2);
	/*
	ctx.lineJoin="miter";	//轉折點的樣式, miter(default), round扇形 和 bevel三角形
ctx.miterLimit=5;		//最大斜接長度。斜接長度指的是在兩條線交匯處內角和外角之間的距離。

lineCap 線條端點的樣式, butt(default)方形, square 和 round圓形
setLineDash 方法和 lineDashOffset 屬性來制定虛線樣式
來源 https://kknews.cc/zh-tw/code/6azm5bl.html
	*/
}

function gps2scr(sourcePs){
	//經緯度座標「批次」轉螢幕座標
	//「假設」經緯度間隔等比例
	//但到時圖片貼上就偏了...
	var newPs=new Array();
	for(var i=0; i<sourcePs.length; i++){
		newPs[i] = new Array();
		newPs[i][0] =  (sourcePs[i][1] - centerCoords[1] )* zoom + centerX;
		newPs[i][1] = -(sourcePs[i][0] - centerCoords[0] )*zoom + centerY;
	}
	return newPs;
}

function drawPoint(lat, lon, color, width){
	var drawX = (lon - centerCoords[1] )* zoom + centerX;
	var drawY = -(lat - centerCoords[0] )*zoom + centerY;
	//console.log(drawX + "," + drawY);
	ctx.strokeStyle = "red";	//線條色
	ctx.lineWidth = "1";	//線條粗度
	ctx.beginPath();
    ctx.arc(drawX, drawY,1,0,Math.PI*2,true);
	ctx.stroke();
}

function geoYes(evt){
	// showMsg("geoYes()");
	
	recentPoint[0] = evt.coords.latitude;
	recentPoint[1] = evt.coords.longitude;
	
	if(searchPoint){
		searchPoint = false;
		//從路徑上找到最近的下一目標點, 但可能是適當點的前一點
		//最近點距離過大可能表示不在路徑上
		var shortstDist = getDistance(recentPoint,  points[0]);
		for(var i=1; i< points.length; i++){
			dist = getDistance(recentPoint,  points[i]);
			if(dist < shortstDist){
				shortstDist = dist;
				nextPoint = i;
			}
		}
	}
	// showMsg("searchPoint()");
	
	if(viewMode == 1){		//全圖：只畫點
		drawPoint(recentPoint[0], recentPoint[1]);
	}else{		//置中：全重畫, 不畫點
		centerCoords[0] = recentPoint[0];
		centerCoords[1] = recentPoint[1];
		drawClearMap();
		drawMiddleCross();
		drawBaseMap();
	}
	
	//showMsg(",23");
	nextDist = getDistance(recentPoint,  points[nextPoint]);

	
	angle1 = Math.atan((recentPoint[0]- points[nextPoint][0])/(recentPoint[1] - points[nextPoint][1]));
	shadowDist = Math.cos(angle1- pathAngle) * nextDist;
	//投影距離無法適用較大的轉角, 還是要用分角線y=ax+b
	//cos為距節點的投影距離, 用sin則為與路徑中線的距離

		str = new Date().getSeconds()+",";
			if(vector == -1){
		str += "(回程)";
	}else{
		str += "(去程)";
	}
		str += ","+points[nextPoint][2];
	str += "," + nextDist+"公里";
	//document.getElementById("posStr").innerHTML=str;
	showData(evt);
	
		//時速80以上(高速公路, 開80不提醒?), 2公里前第一次提醒
	if(enAlarmHigh && nextDist < 2 && evt.coords.speed*3.6 >80){
		playVoice(points[nextPoint][4-vector]);
		enAlarmHigh = false;
		return;
	}
	/** 事前提醒*/
	//時速60公里 = 60x1000/60x60 = 60/3.6 = 16.6公尺/秒(步行4公里/小時)
	//車速每10公里提前2秒通知：
	//		120公里提前24秒, 33*24=792
	//		30公里時提前6秒通知,約8.1*6=48公尺。
	//		10公里,3秒,約4.1*3公尺,。
	//最後加10公尺給單車時,路中與路邊的距離補償用
	minDist = evt.coords.speed/1000 * evt.coords.speed*3.6/10*2 + 0.01;
	if(minDist < 0.05){
		minDist = 0.05;
	}
	
	if(enAlarm  && nextDist < minDist){
		//showMsg("minDist=" + minDist);
		playVoice(points[nextPoint][4-vector]);
		enAlarm = false;
		// return;
	}
	
	/**判定為通過*/
	//a.近距離內距離變大。依車速修正(2秒距離)
	//b.距離增加超過3次(至少要3+1秒?)
	//c.從分角線的一邊到另一邊(距離從正變負數, 所以相乘為負)

	if (nextDist > preDist ){
		if(nextDist - preDist >0.002){
			incDistCnt ++;
		}
		if(incDistCnt == 2  ||	//距離增加連續2次
			nextDist < evt.coords.speed/1000 * 2 + 0.01 ){		//靠近後距離增加
			skipPoint();
			incDistCnt = 0;
			preDist = getDistance(recentPoint,  points[nextPoint]);
			pathAngle =  Math.atan((passPoint[0]- points[nextPoint][0])/(passPoint[1] - points[nextPoint][1]));
		}
	}else{
		preDist = nextDist;
		incDistCnt = 0;
	}
	// showMsg(",33");
}

function _geoNo(evt){
	/*
		TODO 本函式塞到 watchPosition內。
		限https? win10本機檔用Chrome可開允許,但仍取得失敗。 手機note9待測
		Only secure origins are allowed 安全來源才可用geo...
		https://kknews.cc/zh-tw/tech/4qgkxq2.html
	*/
	if(evt.code == 1){
		showMsg("GPS未允用！");
	}else{
		showMsg(evt.code + ", " + evt.message);
	}
}

var watchID;
function startGPS(){
	//showMsg("startGPS()");
	if (!navigator.geolocation) {
		showMsg("GPS不支援。");
		return;
	}

		// navigator.geolocation.getCurrentPosition( geoYes, geoNo);
	navigator.permissions.query({name:'geolocation'}).then(function(result) {
		//權限判斷以乎對重覆檢查GPS是否啟用沒有關聯。
		if (result.state == 'denied') {	//denied禁用, prompt詢問, granted允許
			showMsg("GPS禁用！");
		}
		result.onchange = function() {
		}
	});
	/*
	var options = {
	  enableHighAccuracy: true,	//高精度, 實測更新間隔約1秒, 否則約20秒。
	  timeout: 5000,						//在note9用chrome會Timeout expired。
	  maximumAge: 0						//快取的過期時間，單位是毫秒，設為0來禁用快取讀取。
	};
	*/
	watchID = navigator.geolocation.watchPosition( geoYes, 
		//就算成功, 但中途失敗不會告知?
		(evt) =>{
				if(evt.code == 1){
					showMsg("GPS沒開！");	//User denied Geolocation
					//失敗後就不管了, 如何每秒檢查一次?
				}else{
					showMsg(evt.code + ", " + evt.message);
					//2, Network location provider at 'https://www.googleapis.com/' : ERR_NAME_NOT_RESOLVED
				}
		}, {enableHighAccuracy: true});
}

function stopGPS(){
	navigator.geolocation.clearWatch( watchID );
	showMsg("GPS停止定位。");
}

function getDistance(coord1, coord2) {
	//兩座標間的距離, 傳回：單位公里, 小數點後三位
    //本函式來源 https://www.geodatasource.com/developers/javascript
	lat1	= coord1[0].toFixed(5);	//用小數5位算距離
	lon1= coord1[1].toFixed(5);
	lat2	= coord2[0].toFixed(5);
	lon2= coord2[1].toFixed(5);
	
    var radlat1 = Math.PI * lat1/180;
    var radlat2 = Math.PI * lat2/180;
    var theta = lon1-lon2;
    var radtheta = Math.PI * theta/180;
    var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
    if (dist > 1) {
        dist = 1;
    }
    dist = Math.acos(dist);
    dist = dist * 180/Math.PI;
    dist = dist * 60 * 1.1515;	//不明常數
    dist = dist * 1.609344 ;		//英浬轉公里

    return dist.toFixed(4);		//小數點後三位(四捨「六入」)
}

function showData(evt){
	//str = "任務：" + points[0][2] + " - " + points[points.length-1][2];
	str = "";
			var d=new Date();
		strTime = d.getHours()+":" + d.getMinutes()+ ":" +d.getSeconds();		//+"."+d.getMilliseconds;
		str += strTime;
		str +="<br>";
	if(vector == -1){
		str += "(回程)";
	}else{
		str += "(去程)";
	}
	str += points[nextPoint][2];
	

		//str += "<br />距離：<br />時速：";

		// if(nextDist >1){
			
		// }else{
			// str += "，" + (nextDist*1000).toFixed() + "公尺，";
			// }
	if(evt == undefined){
			str+= evt;
	}else{
		str += "，" + nextDist.toFixed(1)  + "公里，";
		arriveSec =  nextDist*1000/evt.coords.speed;
		if(arriveSec < 99){
			str += arriveSec.toFixed(0)+"秒。";
		}
		//alert(str);
		//str += "<br />位置：" + recentPoint[0] + ", "+ recentPoint[1];
		str += "<br/>時速："+ (evt.coords.speed*3.6).toFixed(1) + "公里。";	//原單位：米/秒
		str += "方向：" + Math.round(evt.coords.heading);	//方向為正北的順時針

	}

	//	str += "("+ points[nextPoint][0] +", " + points[nextPoint][1];
	
	document.getElementById("posStr").innerHTML=str;
}

var msgList = ["","","","",""];
var msgID = 0;
function  showMsg(str){
	msgList[msgID] = str;
	output = msgList[msgID] + "<br/>";

	for(i=msgID+1; i < msgList.length; i++){
		output += msgList[i] + "。";
	}
	for(i=0; i < msgID; i++){
		output += msgList[i] + "。";
	}
	// console.log(output);
	document.getElementById("watchStr").innerHTML= output;
	
	msgID --;	//新的訊息放前面
	if(msgID < 0){
		msgID = msgList.length - 1;
	}
}

function newCache(){
			cache.delete('.');
		cache.delete('index.html');
	//將"gps"快取中的key全部刪除
	/*
	caches.open('gps')
		.then(function(cache) {
			cache.keys()
			.then(function(keys) {
				keys.forEach(function(request, index, array) {
					cache.delete(request);
				});
			});
		});
	*/	
}

function displayNotification(){
    if('serviceWorker' in navigator){
        var options = {
            body: '歡迎進入30天PWA的世界'           
        };
        navigator.serviceWorker.ready
            .then(function(sw){
                sw.showNotification('訂閱成功！！！', options);
            })
    }  else{
		
	}
     
}

var IntervalID;
var countRun = false;
var isMarch = -1;
var march = document.getElementById("march");
var timeNum = [40,,60];	//TODO 連續號誌使用同一時序。轉向時兩個值互換。
var colorList = ["red",,"green"];
/**紅綠燈讀秒, 時間到或用戶點選時會變色及重數 */

function swColor(){
	_todo._810紅綠燈讀秒 = function(){}	//AAAAAAAA
	if(!countRun){
		//停止狀態則啟動
		IntervalID = window.setInterval(( () =>  {
			//休眠狀態將回調函數放在隊列中,等瀏覽器再次打開的時候，一瞬間全部執行
			if(count < 0){
				isMarch *= -1;
				count = timeNum[1+isMarch];
				march.style.color = colorList[1+isMarch];
			}
			march.innerText = count--;
		}	) , 1000);
		count = timeNum[1+isMarch];
		countRun=true;
	}else{
		isMarch *= -1;
		count = timeNum[1+isMarch];
		march.style.color = colorList[1+isMarch];
		march.innerText = count--;
	}
}

function exportCoord(){
//座標清單匯出檔案,再用Http_file_server傳到電腦
  var fileName = "a.csv";//匯出的檔名
  var data = ins.innerHTML;	//TODO 要把BR改成\n\r
  var blob = new Blob([data], {
    type : "application/octet-stream"
  });
  //實作一個標簽, 好像不正規。
  var href = URL.createObjectURL(blob);
  var link = document.createElement("a");
  document.body.appendChild(link);
  link.href = href;
  link.download = fileName;
  link.click();
}

//document.getElementById('input').click();
// document.getElementById("fileInput").onchange = () => {
  // const selectedFiles = [...fileInput.files];
  // console.log(selectedFiles);
// }

/**
	程式功能：手機/GPS, 於特定路線上目標點提示路況(提早放油門, 減少煞車)
	目標1：山路有坑洞與急彎要提前通知
		資料源：除用gmap取得座標,內建路徑, 移動中要即時記錄,儲存(小數後七位不夠)
			儲存：csv匯入indexDB, 插入, 匯出
				設定：5個按鈕直接顯示在畫面上, 開車者要去按。
					暫時方案：存到本地變數
		語音：先上網下載並cache。之後可自行錄音, 存到cache
				
		
	目標2：平面道路紅綠燈讀秒(先手動)
	目標3：提醒下交流道???
	
	必要條件：GPS沒開要持續watch, 中途沒GPS要提示, 卡住了
	
	錯誤處理：
		手機上的文字大小會變動???
*/
</script>
</html>